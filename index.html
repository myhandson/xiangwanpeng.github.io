<!doctype html>



  


<html class="theme-next pisces use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/VEN/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/VEN/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.1" />






<meta name="description" content="Better late than never.">
<meta property="og:type" content="website">
<meta property="og:title" content="向万鹏的独立博客">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="向万鹏的独立博客">
<meta property="og:description" content="Better late than never.">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="向万鹏的独立博客">
<meta name="twitter:description" content="Better late than never.">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"always"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 0,
      author: '博主'
    }
  };
</script>




  <link rel="canonical" href="http://yoursite.com/"/>

  <title> 向万鹏的独立博客 </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">向万鹏的独立博客</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/12/21/mybatis一级缓存和二级缓存/" itemprop="url">
                  mybatis一级缓存和二级缓存
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-12-21T21:18:31+08:00" content="2016-12-21">
              2016-12-21
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/mybatis/" itemprop="url" rel="index">
                    <span itemprop="name">mybatis</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/12/21/mybatis一级缓存和二级缓存/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/12/21/mybatis一级缓存和二级缓存/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="mybatis一级缓存"><a href="#mybatis一级缓存" class="headerlink" title="mybatis一级缓存"></a>mybatis一级缓存</h2><p>　　mybatis一级缓存是SqlSession级别的缓存。<br>　　一级缓存的作用域是同一个SqlSession，在同一个sqlSession中两次执行相同的sql语句，第一次执行完毕会将数据库中查询的数据写到缓存（内存），第二次会从缓存中获取数据将不再从数据库查询，从而提高查询效率。当一个sqlSession结束后该sqlSession中的一级缓存也就不存在了。<br>　　mybatis默认开启一级缓存。<br>　　<br>　　下面测试一级缓存，首先创建数据库表c_user并插入两条数据：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> c_user(</div><div class="line">	<span class="keyword">id</span> <span class="built_in">INT</span> PRIMARY <span class="keyword">KEY</span> AUTO_INCREMENT, </div><div class="line">	<span class="keyword">NAME</span> <span class="built_in">VARCHAR</span>(<span class="number">20</span>), </div><div class="line">	age <span class="built_in">INT</span></div><div class="line">);</div><div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> c_user(<span class="keyword">NAME</span>, age) <span class="keyword">VALUES</span>(<span class="string">'Tom'</span>, <span class="number">12</span>);</div><div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> c_user(<span class="keyword">NAME</span>, age) <span class="keyword">VALUES</span>(<span class="string">'Jack'</span>, <span class="number">11</span>);</div></pre></td></tr></table></figure></p>
<p><img src="http://static.zybuluo.com/xiangwanpeng/42nnn39uopwpt4zp1kec5gqb/image_1b4gr4fo2gn518ihfd2eli1tbg9.png" alt="image_1b4gr4fo2gn518ihfd2eli1tbg9.png-13.9kB"></p>
<p>创建实体类CUser：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CUser</span> </span>&#123;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">int</span> id;</div><div class="line">	<span class="keyword">private</span> String name;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">int</span> age;</div><div class="line"></div><div class="line">　　<span class="comment">//getters and setters</span></div><div class="line">　　</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> <span class="string">"CUser [id="</span> + id + <span class="string">", name="</span> + name + <span class="string">", age="</span> + age + <span class="string">"]"</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">CUser</span><span class="params">(<span class="keyword">int</span> id, String name, <span class="keyword">int</span> age)</span> </span>&#123;</div><div class="line">		<span class="keyword">super</span>();</div><div class="line">		<span class="keyword">this</span>.id = id;</div><div class="line">		<span class="keyword">this</span>.name = name;</div><div class="line">		<span class="keyword">this</span>.age = age;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">CUser</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">super</span>();</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>编写配置文件userMapper.xml：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</div><div class="line"><span class="meta">&lt;!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd"&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">"com.mybatis.test9.userMapper"</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"getCUser"</span> <span class="attr">parameterType</span>=<span class="string">"int"</span> <span class="attr">resultType</span>=<span class="string">"CUser"</span>&gt;</span></div><div class="line">		select * from c_user where id=#&#123;id&#125;</div><div class="line">	<span class="tag">&lt;/<span class="name">select</span>&gt;</span></div><div class="line">	</div><div class="line">	<span class="tag">&lt;<span class="name">update</span> <span class="attr">id</span>=<span class="string">"updateCUser"</span> <span class="attr">parameterType</span>=<span class="string">"CUser"</span>&gt;</span></div><div class="line">		update c_user set name = #&#123;name&#125;,age = #&#123;age&#125; where id = #&#123;id&#125;</div><div class="line">	<span class="tag">&lt;/<span class="name">update</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>首先测试一级缓存的作用：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@org</span>.junit.<span class="function">Test</span></div><div class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testCache1</span><span class="params">()</span> &#123;</div><div class="line">        String resource = <span class="string">"conf.xml"</span>;</div><div class="line">        InputStream is = <span class="keyword">this</span>.getClass().getClassLoader().getResourceAsStream(resource);</div><div class="line"></div><div class="line">        SqlSessionFactory sessionFactory = <span class="keyword">new</span> SqlSessionFactoryBuilder().build(is);</div><div class="line">        SqlSession session = sessionFactory.openSession();</div><div class="line"></div><div class="line">        String statement = <span class="string">"com.mybatis.test9.userMapper"</span>+<span class="string">".getCUser"</span>;</div><div class="line">        CUser user1 = session.selectOne(statement, <span class="number">1</span>);</div><div class="line">        System.out.println(user1);</div><div class="line">        </div><div class="line">        CUser user2 = session.selectOne(statement, <span class="number">1</span>);</div><div class="line">        System.out.println(user2);</div><div class="line">	&#125;</div></pre></td></tr></table></figure></p>
<p>运行结果：</p>
<p><img src="http://static.zybuluo.com/xiangwanpeng/6u8e9v14goadxr6ofuc66c7x/image_1b4i6di3n5501kg4mr41llu169l13.png" alt="image_1b4i6di3n5501kg4mr41llu169l13.png-39.8kB"></p>
<p>　　从运行结果中发现，虽然执行了两次selectOne函数，但是只执行了一条SELECT语句。这是由于两次查找的条件相同，即都是查询id为1的记录，所以缓存起了作用，第二次执行selectOne方法并没有重新去数据库查询记录。<br>　　那么，哪些情况下会重新去数据库执行查询操作呢？有下面几种情况：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@org</span>.junit.<span class="function">Test</span></div><div class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testClearCache1</span><span class="params">()</span> &#123;</div><div class="line">        String resource = <span class="string">"conf.xml"</span>;</div><div class="line">        InputStream is = <span class="keyword">this</span>.getClass().getClassLoader().getResourceAsStream(resource);</div><div class="line"></div><div class="line">        SqlSessionFactory sessionFactory = <span class="keyword">new</span> SqlSessionFactoryBuilder().build(is);</div><div class="line">        SqlSession session = sessionFactory.openSession();</div><div class="line"></div><div class="line">        String statement1 = <span class="string">"com.mybatis.test9.userMapper"</span>+<span class="string">".getCUser"</span>;</div><div class="line">        String statement2 = <span class="string">"com.mybatis.test9.userMapper"</span>+<span class="string">".updateCUser"</span>;</div><div class="line">        CUser user1 = session.selectOne(statement1, <span class="number">1</span>);</div><div class="line">        System.out.println(user1);</div><div class="line">        </div><div class="line">        <span class="comment">//1. 如果查询条件改变，会重新查询</span></div><div class="line">        CUser user2 = session.selectOne(statement1, <span class="number">2</span>);</div><div class="line">        System.out.println(user2);</div><div class="line">        </div><div class="line">        <span class="comment">//2. 如果SqlSession执行了commit，clearCache或者close，会重新查询</span></div><div class="line">        <span class="comment">//提交后会清空缓存</span></div><div class="line">        session.commit();</div><div class="line">        user2 = session.selectOne(statement1, <span class="number">1</span>);</div><div class="line">        </div><div class="line">        <span class="comment">//执行clearCache清空缓存</span></div><div class="line">        session.clearCache();</div><div class="line">        user2 = session.selectOne(statement1, <span class="number">1</span>);</div><div class="line">        </div><div class="line">        <span class="comment">//关闭session后再开启，也会清空缓存</span></div><div class="line">        session.close();</div><div class="line">        session = sessionFactory.openSession();</div><div class="line">        user2 = session.selectOne(statement1, <span class="number">1</span>);</div><div class="line">        </div><div class="line">        <span class="comment">//3. 执行增删改操作，即使还没有commit，也会清空缓存</span></div><div class="line">        CUser newCUser = <span class="keyword">new</span> CUser(<span class="number">2</span>,<span class="string">"Jerry"</span>,<span class="number">12</span>);</div><div class="line">        session.update(statement2,newCUser);</div><div class="line">        user2 = session.selectOne(statement1, <span class="number">1</span>);</div><div class="line">        System.out.println(user2);</div><div class="line">	&#125;</div></pre></td></tr></table></figure></p>
<p>运行结果：</p>
<p><img src="http://static.zybuluo.com/xiangwanpeng/pfjw1l894i9echmrssc7ayd4/image_1b4i6f5ficbv48boiolk0hge1g.png" alt="image_1b4i6f5ficbv48boiolk0hge1g.png-120.7kB"></p>
<h2 id="mybatis二级缓存"><a href="#mybatis二级缓存" class="headerlink" title="mybatis二级缓存"></a>mybatis二级缓存</h2><p>　　mybatis二级缓存是mapper级别的缓存，多个SqlSession去操作同一个Mapper的sql语句，多个SqlSession去操作数据库得到数据会存在二级缓存区域，多个SqlSession可以共用二级缓存，二级缓存是跨SqlSession的。<br>　　二级缓存是多个SqlSession共享的，其作用域是mapper的同一个namespace，不同的sqlSession两次执行相同namespace下的sql操作且向sql中传递参数也相同，即最终执行相同的sql语句，第一次执行完毕会将数据库中查询的数据写到缓存（内存），第二次会从缓存中获取数据将不再从数据库查询，从而提高查询效率。<br>　　在mybatis的配置文件中，二级缓存的总开关默认已经开启，但是对应的映射文件中没有配置开启二级缓存，所以需要在具体的mapper.xml中开启二级缓存。<br>　　下面测试mybatis二级缓存，首先需要在对应的映射文件中开启二级缓存：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</div><div class="line"><span class="meta">&lt;!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd"&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">"com.mybatis.test10.userMapper"</span>&gt;</span></div><div class="line"></div><div class="line">	<span class="comment">&lt;!-- 开启二级缓存 --&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">cache</span>&gt;</span><span class="tag">&lt;/<span class="name">cache</span>&gt;</span></div><div class="line">	</div><div class="line">	<span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"getCUser"</span> <span class="attr">parameterType</span>=<span class="string">"int"</span> <span class="attr">resultType</span>=<span class="string">"CUser"</span>&gt;</span></div><div class="line">		select *</div><div class="line">		from c_user where id=#&#123;id&#125;</div><div class="line">	<span class="tag">&lt;/<span class="name">select</span>&gt;</span></div><div class="line"></div><div class="line">	<span class="tag">&lt;<span class="name">update</span> <span class="attr">id</span>=<span class="string">"updateCUser"</span> <span class="attr">parameterType</span>=<span class="string">"CUser"</span>&gt;</span></div><div class="line">		update c_user set name =</div><div class="line">		#&#123;name&#125;,age = #&#123;age&#125; where id = #&#123;id&#125;</div><div class="line">	<span class="tag">&lt;/<span class="name">update</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>而且需要是被缓存的实体类实现Serializable接口：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CUser</span> <span class="keyword">implements</span> <span class="title">Serializable</span></span>&#123;</div><div class="line">        ...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>编写测试类测试二级缓存：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="meta">@org</span>.junit.<span class="function">Test</span></div><div class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testCache2</span><span class="params">()</span> &#123;</div><div class="line">        String resource = <span class="string">"conf.xml"</span>;</div><div class="line">        InputStream is = <span class="keyword">this</span>.getClass().getClassLoader().getResourceAsStream(resource);</div><div class="line"></div><div class="line">        SqlSessionFactory sessionFactory = <span class="keyword">new</span> SqlSessionFactoryBuilder().build(is);</div><div class="line">        </div><div class="line">        <span class="comment">//获取两个不同的SqlSession</span></div><div class="line">        SqlSession session1 = sessionFactory.openSession();</div><div class="line">        SqlSession session2 = sessionFactory.openSession();</div><div class="line"></div><div class="line">        String statement1 = <span class="string">"com.mybatis.test10.userMapper"</span>+<span class="string">".getCUser"</span>;</div><div class="line">        </div><div class="line">        CUser user1 = session1.selectOne(statement1, <span class="number">1</span>);</div><div class="line">        <span class="comment">//前一个session执行commit后，二级缓存才会生效</span></div><div class="line">        session1.commit();</div><div class="line">        CUser user2 = session2.selectOne(statement1, <span class="number">1</span>);</div><div class="line">        </div><div class="line">        System.out.println(user1);</div><div class="line">        System.out.println(user2);</div><div class="line">        </div><div class="line">	&#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>运行结果：</p>
<p><img src="http://static.zybuluo.com/xiangwanpeng/tke0xaxn32g33t9f2xf3v4lc/image_1b4i7d5tj1ijc1me26rppilfgl1t.png" alt="image_1b4i7d5tj1ijc1me26rppilfgl1t.png-42.9kB"></p>
<p>可以看到，虽然是通过两个不同的SqlSession查询记录，但是只执行了一次SELECT语句，这正是mybatis二级缓存的作用。</p>
<p>注意点：</p>
<ol>
<li>需要在对应的映射文件中配置开启二级缓存。</li>
<li>被缓存的实体类需要实现Serializable接口。</li>
<li>SqlSession必须执行commit或者close方法后，其中的数据才会被写入到二级缓存。</li>
<li>当执行了增删改操作后，会刷新二级缓存：<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@org</span>.junit.<span class="function">Test</span></div><div class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testClearCache2</span><span class="params">()</span> &#123;</div><div class="line">        String resource = <span class="string">"conf.xml"</span>;</div><div class="line">        InputStream is = <span class="keyword">this</span>.getClass().getClassLoader().getResourceAsStream(resource);</div><div class="line"></div><div class="line">        SqlSessionFactory sessionFactory = <span class="keyword">new</span> SqlSessionFactoryBuilder().build(is);</div><div class="line">        </div><div class="line">        <span class="comment">//获取两个不同的SqlSession</span></div><div class="line">        SqlSession session1 = sessionFactory.openSession();</div><div class="line">        SqlSession session2 = sessionFactory.openSession();</div><div class="line"></div><div class="line">        String statement1 = <span class="string">"com.mybatis.test10.userMapper"</span>+<span class="string">".getCUser"</span>;</div><div class="line">        String statement2 = <span class="string">"com.mybatis.test10.userMapper"</span>+<span class="string">".updateCUser"</span>;</div><div class="line">        </div><div class="line">        CUser user1 = session1.selectOne(statement1, <span class="number">1</span>);</div><div class="line">        </div><div class="line">        <span class="comment">//当执行了增删改操作后，会刷新二级缓存</span></div><div class="line">        CUser newUser = <span class="keyword">new</span> CUser(<span class="number">2</span>, <span class="string">"Bob"</span>, <span class="number">14</span>);</div><div class="line">        session1.update(statement2,newUser);</div><div class="line">        session1.commit();</div><div class="line">        </div><div class="line">        CUser user2 = session2.selectOne(statement1, <span class="number">1</span>);</div><div class="line">        </div><div class="line">        System.out.println(user1);</div><div class="line">        System.out.println(user2);</div><div class="line">        </div><div class="line">	&#125;</div></pre></td></tr></table></figure>
</li>
</ol>
<p>运行结果如下：<br><img src="http://static.zybuluo.com/xiangwanpeng/xuene43ndzdmj2r9nqaconpe/image_1b4i83is91t08135r1nbs103cee42a.png" alt="image_1b4i83is91t08135r1nbs103cee42a.png-76.4kB"></p>
<p>　　在映射文件中配置开启二级缓存时，cache节点还可以配置如下属性：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!-- 开启二级缓存 --&gt;</span></div><div class="line">	<span class="comment">&lt;!-- eviction="FIFO"指定回收策略为先进先出 --&gt;</span></div><div class="line">	<span class="comment">&lt;!-- flushInterval="60000"指定自动刷新时间为60s --&gt;</span></div><div class="line">	<span class="comment">&lt;!-- size="512"指定最多缓存512个引用对象 --&gt;</span></div><div class="line">	<span class="comment">&lt;!-- readOnly="true"表示返回的对象是只读的 --&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">cache</span> <span class="attr">eviction</span>=<span class="string">"FIFO"</span> <span class="attr">flushInterval</span>=<span class="string">"60000"</span> <span class="attr">size</span>=<span class="string">"512"</span> <span class="attr">readOnly</span>=<span class="string">"true"</span>&gt;</span><span class="tag">&lt;/<span class="name">cache</span>&gt;</span></div></pre></td></tr></table></figure></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/12/21/mybatis调用存储过程/" itemprop="url">
                  mybatis调用存储过程
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-12-21T20:26:31+08:00" content="2016-12-21">
              2016-12-21
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/mybatis/" itemprop="url" rel="index">
                    <span itemprop="name">mybatis</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/12/21/mybatis调用存储过程/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/12/21/mybatis调用存储过程/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>　　现在通过调用数据库的存储过程，实现这样一种功能：有一张表p_user，当传入参数为0时，返回表中女性记录的数量，否则，返回表中男性记录的数量。<br>　<br>创建数据表并插入数据：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">create</span> <span class="keyword">table</span> p_user(  </div><div class="line">	<span class="keyword">id</span> <span class="built_in">int</span> primary <span class="keyword">key</span> auto_increment,  </div><div class="line">	<span class="keyword">name</span> <span class="built_in">varchar</span>(<span class="number">10</span>),</div><div class="line">	sex <span class="built_in">char</span>(<span class="number">2</span>)</div><div class="line">); </div><div class="line"></div><div class="line"><span class="keyword">insert</span> <span class="keyword">into</span> p_user(<span class="keyword">name</span>,sex) <span class="keyword">values</span>(<span class="string">'A'</span>,<span class="string">"男"</span>);  </div><div class="line"><span class="keyword">insert</span> <span class="keyword">into</span> p_user(<span class="keyword">name</span>,sex) <span class="keyword">values</span>(<span class="string">'B'</span>,<span class="string">"女"</span>);  </div><div class="line"><span class="keyword">insert</span> <span class="keyword">into</span> p_user(<span class="keyword">name</span>,sex) <span class="keyword">values</span>(<span class="string">'C'</span>,<span class="string">"男"</span>);</div></pre></td></tr></table></figure></p>
<p><img src="http://static.zybuluo.com/xiangwanpeng/reab452e0cmle16bqvbdxvye/image_1b4glot05ei18ik1i0u10631n6n9.png" alt="image_1b4glot05ei18ik1i0u10631n6n9.png-14.5kB"></p>
<p>创建存储过程，查询得到男性或女性的数量，如果传入的是0就女性否则是男性：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">DELIMITER $</div><div class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> mybatis.get_user_count(<span class="keyword">IN</span> sex_id <span class="built_in">INT</span>, <span class="keyword">OUT</span> user_count <span class="built_in">INT</span>)</div><div class="line"><span class="keyword">BEGIN</span>  </div><div class="line"><span class="keyword">IF</span> sex_id=<span class="number">0</span> <span class="keyword">THEN</span></div><div class="line"><span class="keyword">SELECT</span> <span class="keyword">COUNT</span>(*) <span class="keyword">FROM</span> mybatis.p_user <span class="keyword">WHERE</span> p_user.sex=<span class="string">'女'</span> <span class="keyword">INTO</span> user_count;</div><div class="line">ELSE</div><div class="line"><span class="keyword">SELECT</span> <span class="keyword">COUNT</span>(*) <span class="keyword">FROM</span> mybatis.p_user <span class="keyword">WHERE</span> p_user.sex=<span class="string">'男'</span> <span class="keyword">INTO</span> user_count;</div><div class="line"><span class="keyword">END</span> <span class="keyword">IF</span>;</div><div class="line"><span class="keyword">END</span> </div><div class="line">$</div></pre></td></tr></table></figure></p>
<p>创建实体类User：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PUser</span> </span>&#123;</div><div class="line">	<span class="keyword">private</span> String id;</div><div class="line">	<span class="keyword">private</span> String name;</div><div class="line">	<span class="keyword">private</span> String sex;</div><div class="line"></div><div class="line">	<span class="comment">//getters and setters</span></div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> <span class="string">"PUser [id="</span> + id + <span class="string">", name="</span> + name + <span class="string">", sex="</span> + sex + <span class="string">"]"</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">PUser</span><span class="params">(String id, String name, String sex)</span> </span>&#123;</div><div class="line">		<span class="keyword">super</span>();</div><div class="line">		<span class="keyword">this</span>.id = id;</div><div class="line">		<span class="keyword">this</span>.name = name;</div><div class="line">		<span class="keyword">this</span>.sex = sex;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">PUser</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">super</span>();</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>创建映射文件userMapper.xml：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</div><div class="line"><span class="meta">&lt;!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd"&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">"com.mybatis.test8.userMapper"</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"getCount"</span> <span class="attr">statementType</span>=<span class="string">"CALLABLE"</span> <span class="attr">parameterMap</span>=<span class="string">"getCountMap"</span>&gt;</span></div><div class="line">	call mybatis.get_user_count(?,?)</div><div class="line">	<span class="tag">&lt;/<span class="name">select</span>&gt;</span></div><div class="line">	</div><div class="line">	<span class="tag">&lt;<span class="name">parameterMap</span> <span class="attr">type</span>=<span class="string">"java.util.Map"</span> <span class="attr">id</span>=<span class="string">"getCountMap"</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">parameter</span> <span class="attr">property</span>=<span class="string">"sex_id"</span> <span class="attr">mode</span>=<span class="string">"IN"</span> <span class="attr">jdbcType</span>=<span class="string">"INTEGER"</span>/&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">parameter</span> <span class="attr">property</span>=<span class="string">"user_count"</span> <span class="attr">mode</span>=<span class="string">"OUT"</span> <span class="attr">jdbcType</span>=<span class="string">"INTEGER"</span>/&gt;</span></div><div class="line">	<span class="tag">&lt;/<span class="name">parameterMap</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>编写测试类：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</div><div class="line">	</div><div class="line">	<span class="keyword">private</span> SqlSessionFactory sessionFactory;</div><div class="line">	<span class="keyword">private</span> SqlSession session;</div><div class="line"></div><div class="line">	<span class="meta">@Before</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span></span>&#123;</div><div class="line">		<span class="comment">//读取配置文件</span></div><div class="line">        String resource = <span class="string">"conf.xml"</span>;</div><div class="line">        InputStream is = <span class="keyword">this</span>.getClass().getClassLoader().getResourceAsStream(resource);</div><div class="line"></div><div class="line">        <span class="comment">//创建SqlSessionFactory和SqlSession</span></div><div class="line">        sessionFactory = <span class="keyword">new</span> SqlSessionFactoryBuilder().build(is);</div><div class="line">        session = sessionFactory.openSession();</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	<span class="meta">@After</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">free</span><span class="params">()</span></span>&#123;</div><div class="line">		session.commit();</div><div class="line">		session.close();</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	</div><div class="line">	<span class="meta">@org</span>.junit.<span class="function">Test</span></div><div class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getCount</span><span class="params">()</span> &#123;</div><div class="line">        String statement = <span class="string">"com.mybatis.test8.userMapper"</span>+<span class="string">".getCount"</span>;</div><div class="line">        Map&lt;String,Integer&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</div><div class="line">        map.put(<span class="string">"sex_id"</span>, <span class="number">1</span>);</div><div class="line">        session.selectOne(statement, map);</div><div class="line">        <span class="keyword">int</span> userCount = map.get(<span class="string">"user_count"</span>);</div><div class="line">        System.out.println(userCount);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>运行结果：</p>
<p><img src="http://static.zybuluo.com/xiangwanpeng/i466gf4j2grishg49qvuyjso/image_1b4gnq23tgll1aqei2b1u9oi19.png" alt="image_1b4gnq23tgll1aqei2b1u9oi19.png-23kB"></p>
<p>注意点：</p>
<ol>
<li>在映射文件中，需要配置select节点的statementType属性为CALLABLE，且要使用parameterMap属性映射一个存放参数的parameterMap。</li>
<li>需要定义parameterMap，其id与select节点的parameterMap属性一致，type指定parameterMap真实类型为java.util.Map，其中的parameter节点以键值对的形式存放参数，property属性需要和定义在存储过程中的参数名一致。</li>
</ol>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/12/20/mybatis的动态SQL与模糊查询/" itemprop="url">
                  mybatis的动态SQL与模糊查询
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-12-20T12:59:39+08:00" content="2016-12-20">
              2016-12-20
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/mybatis/" itemprop="url" rel="index">
                    <span itemprop="name">mybatis</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/12/20/mybatis的动态SQL与模糊查询/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/12/20/mybatis的动态SQL与模糊查询/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>　　现在以一个例子来介绍mybatis的动态SQL和模糊查询：通过多条件查询用户记录，条件为姓名模糊匹配，并且年龄在某两个值之间。<br>　　<br>新建表d_user：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">create</span> <span class="keyword">table</span> d_user(  </div><div class="line">	<span class="keyword">id</span> <span class="built_in">int</span> primary <span class="keyword">key</span> auto_increment,  </div><div class="line">	<span class="keyword">name</span> <span class="built_in">varchar</span>(<span class="number">10</span>),</div><div class="line">	age <span class="built_in">int</span>(<span class="number">3</span>)</div><div class="line">); </div><div class="line"></div><div class="line"><span class="keyword">insert</span> <span class="keyword">into</span> d_user(<span class="keyword">name</span>,age) <span class="keyword">values</span>(<span class="string">'Tom'</span>,<span class="number">12</span>);  </div><div class="line"><span class="keyword">insert</span> <span class="keyword">into</span> d_user(<span class="keyword">name</span>,age) <span class="keyword">values</span>(<span class="string">'Bob'</span>,<span class="number">13</span>);  </div><div class="line"><span class="keyword">insert</span> <span class="keyword">into</span> d_user(<span class="keyword">name</span>,age) <span class="keyword">values</span>(<span class="string">'Jack'</span>,<span class="number">18</span>);</div></pre></td></tr></table></figure></p>
<p>建表成功：</p>
<p><img src="http://static.zybuluo.com/xiangwanpeng/g4kpm83cw9vkgtlscweby6zj/image_1b4gjg2c1f1l1gob9to15lpp3bm.png" alt="image_1b4gjg2c1f1l1gob9to15lpp3bm.png-12.8kB"></p>
<p>新建实体类User：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</div><div class="line">	<span class="keyword">private</span> Integer id;</div><div class="line">	<span class="keyword">private</span> String name;</div><div class="line">	<span class="keyword">private</span> Integer age;</div><div class="line"></div><div class="line">　　<span class="comment">//getters and setters</span></div><div class="line">　　</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> <span class="string">"User [id="</span> + id + <span class="string">", name="</span> + name + <span class="string">", age="</span> + age + <span class="string">"]"</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">User</span><span class="params">(Integer id, String name, Integer age)</span> </span>&#123;</div><div class="line">		<span class="keyword">super</span>();</div><div class="line">		<span class="keyword">this</span>.id = id;</div><div class="line">		<span class="keyword">this</span>.name = name;</div><div class="line">		<span class="keyword">this</span>.age = age;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">User</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">super</span>();</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>创建查询条件实体类ConditionUser：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConditionUser</span> </span>&#123;</div><div class="line">	<span class="keyword">private</span> String name;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">int</span> minAge;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">int</span> maxAge;</div><div class="line"></div><div class="line">　　<span class="comment">//getters and setters</span></div><div class="line">　　</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">ConditionUser</span><span class="params">(String name, <span class="keyword">int</span> minAge, <span class="keyword">int</span> maxAge)</span> </span>&#123;</div><div class="line">		<span class="keyword">super</span>();</div><div class="line">		<span class="keyword">this</span>.name = name;</div><div class="line">		<span class="keyword">this</span>.minAge = minAge;</div><div class="line">		<span class="keyword">this</span>.maxAge = maxAge;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">ConditionUser</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">super</span>();</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>新建映射文件userMapper.xml：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</div><div class="line"><span class="meta">&lt;!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd"&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">"com.mybatis.test7.userMapper"</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"getUser"</span> <span class="attr">parameterType</span>=<span class="string">"ConditionUser"</span> <span class="attr">resultType</span>=<span class="string">"User"</span>&gt;</span></div><div class="line">		SELECT * FROM d_user WHERE age &amp;gt;= #&#123;minAge&#125; AND age &amp;lt;= #&#123;maxAge&#125;</div><div class="line">		<span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"name!=null"</span>&gt;</span></div><div class="line">			AND name LIKE CONCAT(CONCAT('%',#&#123;name&#125;),'%')<span class="tag">&lt;/<span class="name">if</span>&gt;</span></div><div class="line">	<span class="tag">&lt;/<span class="name">select</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>编写测试类：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</div><div class="line">	</div><div class="line">	<span class="keyword">private</span> SqlSessionFactory sessionFactory;</div><div class="line">	<span class="keyword">private</span> SqlSession session;</div><div class="line"></div><div class="line">	<span class="meta">@Before</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span></span>&#123;</div><div class="line">		<span class="comment">//读取配置文件</span></div><div class="line">        String resource = <span class="string">"conf.xml"</span>;</div><div class="line">        InputStream is = <span class="keyword">this</span>.getClass().getClassLoader().getResourceAsStream(resource);</div><div class="line"></div><div class="line">        <span class="comment">//创建SqlSessionFactory和SqlSession</span></div><div class="line">        sessionFactory = <span class="keyword">new</span> SqlSessionFactoryBuilder().build(is);</div><div class="line">        session = sessionFactory.openSession();</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	<span class="meta">@After</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">free</span><span class="params">()</span></span>&#123;</div><div class="line">		session.commit();</div><div class="line">		session.close();</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	</div><div class="line">	<span class="meta">@org</span>.junit.<span class="function">Test</span></div><div class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getUser</span><span class="params">()</span> &#123;</div><div class="line">        String statement = <span class="string">"com.mybatis.test7.userMapper"</span>+<span class="string">".getUser"</span>;</div><div class="line">        ConditionUser conditionUser = <span class="keyword">new</span> ConditionUser(<span class="string">"o"</span>, <span class="number">13</span>, <span class="number">18</span>);</div><div class="line">        List&lt;User&gt; list = session.selectList(statement, conditionUser);</div><div class="line">        System.out.println(list);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>运行结果：</p>
<p><img src="http://static.zybuluo.com/xiangwanpeng/mxvj0hvv61pj3pqkqtioj41g/image_1b4gjeoo71aqa8hc1pg746l1vps9.png" alt="image_1b4gjeoo71aqa8hc1pg746l1vps9.png-12.9kB"></p>
<p>注意：</p>
<ol>
<li>在配置文件中编写sql语句时，为防止大于号和小于号在表示大小关系和表示标签符号之间产生混淆，所以通常用&amp;gt；和&amp;lt；来代替sql语句中大于号和小于号。</li>
<li>在SQL语句中添加动态SQL标签if的原因是，当在后台获取的name属性值为null时，防止生成where name like %null%的条件判断语句，正确的逻辑应该是，当传来的name属性值为null时，取消此筛选条件，即不使用where name like ?的判断条件。在mybatis中，可用的动态SQL标签有：if，choose(when，otherwise)，trim(where,set)，foreach。</li>
<li>在使用模糊查询时，拼接%+#{name}+%的方法有如下几种：</li>
</ol>
<p>(1).像上述例子中一样，在SQL语句中使用CONCAT关键字。</p>
<p>(2).使用${}代替#{}：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</div><div class="line"><span class="meta">&lt;!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd"&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">"com.mybatis.test7.userMapper"</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"getUser"</span> <span class="attr">parameterType</span>=<span class="string">"ConditionUser"</span> <span class="attr">resultType</span>=<span class="string">"User"</span>&gt;</span></div><div class="line">		SELECT * FROM d_user WHERE age &amp;gt;= #&#123;minAge&#125; AND age &amp;lt;= #&#123;maxAge&#125;</div><div class="line">		<span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"name!=null"</span>&gt;</span></div><div class="line">			AND name LIKE '%$&#123;name&#125;%'<span class="tag">&lt;/<span class="name">if</span>&gt;</span></div><div class="line">	<span class="tag">&lt;/<span class="name">select</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>注意，默认情况下，使用#{}语法，MyBatis会产生PreparedStatement语句，并且安全地设置PreparedStatement参数，这个过程中MyBatis会进行必要的安全检查和转义。例如：</p>
<p>执行SQL：select <em> from emp where name = #{employeeName}<br>参数：employeeName=&gt;Smith<br>解析后执行的SQL：select </em> from emp where name = ？</p>
<p>执行SQL：Select <em> from emp where name = ${employeeName}<br>参数：employeeName传入值为：Smith<br>解析后执行的SQL：Select </em> from emp where name =Smith</p>
<p>综上所述，\${}方式可能会引发SQL注入的问题，同时也会影响SQL语句的预编译，所以从安全性和性能的角度出发，应尽量使用#{}。当需要直接插入一个不做任何修改的字符串到SQL语句中，例如在ORDER BY后接一个不添加引号的值作为列名，这时候就需要使用${}。</p>
<p>(3).在程序中拼接。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/12/20/mybatis一对多关联关系/" itemprop="url">
                  mybatis一对多关联关系
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-12-20T10:55:41+08:00" content="2016-12-20">
              2016-12-20
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/mybatis/" itemprop="url" rel="index">
                    <span itemprop="name">mybatis</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/12/20/mybatis一对多关联关系/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/12/20/mybatis一对多关联关系/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>　　在<a href="http://blog.csdn.net/xiangwanpeng/article/details/53760251" target="_blank" rel="external">《mybatis一对一关联关系》</a>中，我们以班级和教师的例子介绍了一对一的关联关系，现在引入学生类，一个学生对应一个班级，一个班级对应多个学生，来介绍mybatis如何处理一对多的关联关系。<br>　　<br>　　首先创建表和实体类：</p>
<p>teacher表：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> teacher(</div><div class="line">	t_id <span class="built_in">INT</span> PRIMARY <span class="keyword">KEY</span> AUTO_INCREMENT, </div><div class="line">	t_name <span class="built_in">VARCHAR</span>(<span class="number">20</span>)</div><div class="line">);</div><div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> teacher(t_name) <span class="keyword">VALUES</span>(<span class="string">'LS1'</span>);</div><div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> teacher(t_name) <span class="keyword">VALUES</span>(<span class="string">'LS2'</span>);</div></pre></td></tr></table></figure></p>
<p><img src="http://static.zybuluo.com/xiangwanpeng/brwue0w8hxyhy8fuaxaunn9p/image_1b4d974o2lm7dfiser8qvj159.png" alt="image_1b4d974o2lm7dfiser8qvj159.png-13.4kB"></p>
<p>class表：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="keyword">class</span>(</div><div class="line">	c_id <span class="built_in">INT</span> PRIMARY <span class="keyword">KEY</span> AUTO_INCREMENT, </div><div class="line">	c_name <span class="built_in">VARCHAR</span>(<span class="number">20</span>), </div><div class="line">	teacher_id <span class="built_in">INT</span></div><div class="line">);</div><div class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> <span class="keyword">class</span> <span class="keyword">ADD</span> <span class="keyword">CONSTRAINT</span> fk_teacher_id FOREIGN <span class="keyword">KEY</span> (teacher_id) <span class="keyword">REFERENCES</span> teacher(t_id);	</div><div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">class</span>(c_name, teacher_id) <span class="keyword">VALUES</span>(<span class="string">'bj_a'</span>, <span class="number">1</span>);</div><div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">class</span>(c_name, teacher_id) <span class="keyword">VALUES</span>(<span class="string">'bj_b'</span>, <span class="number">2</span>);</div></pre></td></tr></table></figure></p>
<p><img src="http://static.zybuluo.com/xiangwanpeng/hvrcdbchp5v22eulfip5isb7/image_1b4d4baab1lar1uf61hfj2so1ge613.png" alt="image_1b4d4baab1lar1uf61hfj2so1ge613.png-14kB"></p>
<p>其中teacher_id是指向teacher表的外键：</p>
<p><img src="http://static.zybuluo.com/xiangwanpeng/b0dacju4qvjgxtnm3ony8u3a/image_1b4d98u561fcn30bon314mp1k6vm.png" alt="image_1b4d98u561fcn30bon314mp1k6vm.png-23.3kB"></p>
<p>student表：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> student(</div><div class="line">	s_id <span class="built_in">INT</span> PRIMARY <span class="keyword">KEY</span> AUTO_INCREMENT, </div><div class="line">	s_name <span class="built_in">VARCHAR</span>(<span class="number">20</span>), </div><div class="line">	class_id <span class="built_in">INT</span></div><div class="line">);</div><div class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> student <span class="keyword">ADD</span> <span class="keyword">CONSTRAINT</span> fk_class_id FOREIGN <span class="keyword">KEY</span> (class_id) <span class="keyword">REFERENCES</span> <span class="keyword">class</span>(c_id);   </div><div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> student(s_name, class_id) <span class="keyword">VALUES</span>(<span class="string">'xs_A'</span>, <span class="number">1</span>);</div><div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> student(s_name, class_id) <span class="keyword">VALUES</span>(<span class="string">'xs_B'</span>, <span class="number">1</span>);</div><div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> student(s_name, class_id) <span class="keyword">VALUES</span>(<span class="string">'xs_C'</span>, <span class="number">1</span>);</div><div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> student(s_name, class_id) <span class="keyword">VALUES</span>(<span class="string">'xs_D'</span>, <span class="number">2</span>);</div><div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> student(s_name, class_id) <span class="keyword">VALUES</span>(<span class="string">'xs_E'</span>, <span class="number">2</span>);</div><div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> student(s_name, class_id) <span class="keyword">VALUES</span>(<span class="string">'xs_F'</span>, <span class="number">2</span>);</div></pre></td></tr></table></figure></p>
<p><img src="http://static.zybuluo.com/xiangwanpeng/xpgjkn8hkrgl68bfwurgy2au/image_1b4d340jksb31n4511659qhbql9.png" alt="image_1b4d340jksb31n4511659qhbql9.png-12.2kB"></p>
<p>其中class_id是指向class表的外键：</p>
<p><img src="http://static.zybuluo.com/xiangwanpeng/pj54mme3kr0y7mh6ar0a2rr9/image_1b4d3uqo3hmueec1c961m57e7cm.png" alt="image_1b4d3uqo3hmueec1c961m57e7cm.png-17.6kB"></p>
<p>实体类Student，Teacher和Classes：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Student</span> </span>&#123;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">int</span> id;</div><div class="line">	<span class="keyword">private</span> String name;</div><div class="line"></div><div class="line">    <span class="comment">//getters and setters</span></div><div class="line">    </div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> <span class="string">"Student [id="</span> + id + <span class="string">", name="</span> + name + <span class="string">"]"</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Student</span><span class="params">(<span class="keyword">int</span> id, String name)</span> </span>&#123;</div><div class="line">		<span class="keyword">super</span>();</div><div class="line">		<span class="keyword">this</span>.id = id;</div><div class="line">		<span class="keyword">this</span>.name = name;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Student</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">super</span>();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Teacher</span> </span>&#123;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">int</span> id;</div><div class="line">	<span class="keyword">private</span> String name;</div><div class="line"></div><div class="line">    <span class="comment">//getters and setters</span></div><div class="line">    </div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> <span class="string">"Teacher [id="</span> + id + <span class="string">", name="</span> + name + <span class="string">"]"</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Teacher</span><span class="params">(<span class="keyword">int</span> id, String name)</span> </span>&#123;</div><div class="line">		<span class="keyword">super</span>();</div><div class="line">		<span class="keyword">this</span>.id = id;</div><div class="line">		<span class="keyword">this</span>.name = name;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Teacher</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">super</span>();</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Classes</span> </span>&#123;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">int</span> id;</div><div class="line">	<span class="keyword">private</span> String name;</div><div class="line">	<span class="keyword">private</span> Teacher teacher;</div><div class="line">	<span class="keyword">private</span> List&lt;Student&gt; students;</div><div class="line"></div><div class="line">    <span class="comment">//getters and setters</span></div><div class="line">    </div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> <span class="string">"Classes [id="</span> + id + <span class="string">", name="</span> + name + <span class="string">", teacher="</span> + teacher + <span class="string">", students="</span> + students + <span class="string">"]"</span>;</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Classes</span><span class="params">(<span class="keyword">int</span> id, String name, Teacher teacher, List&lt;Student&gt; students)</span> </span>&#123;</div><div class="line">		<span class="keyword">super</span>();</div><div class="line">		<span class="keyword">this</span>.id = id;</div><div class="line">		<span class="keyword">this</span>.name = name;</div><div class="line">		<span class="keyword">this</span>.teacher = teacher;</div><div class="line">		<span class="keyword">this</span>.students = students;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Classes</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">super</span>();</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>编写映射文件classesMapper.xml（关键）<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</div><div class="line"><span class="meta">&lt;!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd"&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">"com.mybatis.test6.classesMapper"</span>&gt;</span></div><div class="line"></div><div class="line">	<span class="comment">&lt;!-- </span></div><div class="line">	方法一: 嵌套结果: 使用嵌套结果映射来处理重复的联合结果的子集</div><div class="line">	SELECT * FROM class c, teacher t,student s WHERE c.teacher_id=t.t_id AND c.C_id=s.class_id AND  c.c_id=1</div><div class="line">	 --&gt;</div><div class="line">	<span class="comment">&lt;!-- </span></div><div class="line">		根据classId查询对应的班级信息,包括学生,老师</div><div class="line">	 --&gt;</div><div class="line">	<span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"getClassesById"</span> <span class="attr">parameterType</span>=<span class="string">"int"</span> <span class="attr">resultMap</span>=<span class="string">"classesResultMap"</span>&gt;</span></div><div class="line">		select * from class c,teacher t,student s where c.teacher_id=t.t_id</div><div class="line">		and</div><div class="line">		s.class_id=c.c_id and c.c_id=#&#123;id&#125;</div><div class="line">	<span class="tag">&lt;/<span class="name">select</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">resultMap</span> <span class="attr">type</span>=<span class="string">"Classes"</span> <span class="attr">id</span>=<span class="string">"classesResultMap"</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">id</span> <span class="attr">property</span>=<span class="string">"id"</span> <span class="attr">column</span>=<span class="string">"c_id"</span> /&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"name"</span> <span class="attr">column</span>=<span class="string">"c_name"</span> /&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">association</span> <span class="attr">property</span>=<span class="string">"teacher"</span> <span class="attr">javaType</span>=<span class="string">"Teacher"</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">id</span> <span class="attr">property</span>=<span class="string">"id"</span> <span class="attr">column</span>=<span class="string">"t_id"</span> /&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"name"</span> <span class="attr">column</span>=<span class="string">"t_name"</span> /&gt;</span></div><div class="line">		<span class="tag">&lt;/<span class="name">association</span>&gt;</span></div><div class="line">		<span class="comment">&lt;!-- ofType指定students集合中的对象类型 --&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">collection</span> <span class="attr">property</span>=<span class="string">"students"</span> <span class="attr">ofType</span>=<span class="string">"Student"</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">id</span> <span class="attr">property</span>=<span class="string">"id"</span> <span class="attr">column</span>=<span class="string">"s_id"</span> /&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"name"</span> <span class="attr">column</span>=<span class="string">"s_name"</span> /&gt;</span></div><div class="line">		<span class="tag">&lt;/<span class="name">collection</span>&gt;</span></div><div class="line">	<span class="tag">&lt;/<span class="name">resultMap</span>&gt;</span></div><div class="line"></div><div class="line">	<span class="comment">&lt;!-- </span></div><div class="line">		方法二：嵌套查询：通过执行另外一个SQL映射语句来返回预期的复杂类型</div><div class="line">			SELECT * FROM class WHERE c_id=1;</div><div class="line">			SELECT * FROM teacher WHERE t_id=1   //1 是上一个查询得到的teacher_id的值</div><div class="line">			SELECT * FROM student WHERE class_id=1  //1是第一个查询得到的c_id字段的值</div><div class="line">	 --&gt;</div><div class="line">	<span class="comment">&lt;!-- </span></div><div class="line">		查询所有的班级信息,包括学生,老师</div><div class="line">	 --&gt;</div><div class="line">	<span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"getAllClasses"</span> <span class="attr">resultMap</span>=<span class="string">"allClassesResultMap"</span>&gt;</span></div><div class="line">		select * from class</div><div class="line">	<span class="tag">&lt;/<span class="name">select</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">resultMap</span> <span class="attr">type</span>=<span class="string">"Classes"</span> <span class="attr">id</span>=<span class="string">"allClassesResultMap"</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">id</span> <span class="attr">property</span>=<span class="string">"id"</span> <span class="attr">column</span>=<span class="string">"c_id"</span> /&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"name"</span> <span class="attr">column</span>=<span class="string">"c_name"</span> /&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">association</span> <span class="attr">property</span>=<span class="string">"teacher"</span> <span class="attr">column</span>=<span class="string">"teacher_id"</span></span></div><div class="line">			<span class="attr">select</span>=<span class="string">"getTeacherById"</span>&gt;</div><div class="line">		<span class="tag">&lt;/<span class="name">association</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">collection</span> <span class="attr">property</span>=<span class="string">"students"</span> <span class="attr">column</span>=<span class="string">"c_id"</span></span></div><div class="line">			<span class="attr">select</span>=<span class="string">"getStudentByClassId"</span>&gt;<span class="tag">&lt;/<span class="name">collection</span>&gt;</span></div><div class="line">	<span class="tag">&lt;/<span class="name">resultMap</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"getTeacherById"</span> <span class="attr">parameterType</span>=<span class="string">"int"</span> <span class="attr">resultType</span>=<span class="string">"Teacher"</span>&gt;</span></div><div class="line">		select t_name name from teacher where t_id=#&#123;id&#125;</div><div class="line">	<span class="tag">&lt;/<span class="name">select</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"getStudentByClassId"</span> <span class="attr">parameterType</span>=<span class="string">"int"</span> <span class="attr">resultType</span>=<span class="string">"Student"</span>&gt;</span></div><div class="line">		select s_id id,s_name name from student where class_id=#&#123;id&#125;</div><div class="line">	<span class="tag">&lt;/<span class="name">select</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>这里提供了两种方法处理一对多的关联关系，和一对一中类似，分别是联表查询和分两次查询。关键点在于resultMap节点中的collection节点，注意在联表查询时，需要通过collection节点的ofType属性指定返回的集合的元素类型。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/12/20/mybatis一对一关联关系/" itemprop="url">
                  mybatis一对一关联关系
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-12-20T09:27:28+08:00" content="2016-12-20">
              2016-12-20
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/mybatis/" itemprop="url" rel="index">
                    <span itemprop="name">mybatis</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/12/20/mybatis一对一关联关系/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/12/20/mybatis一对一关联关系/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>　　这篇文章介绍mybatis如何处理一对一的关联关系，假设现在有班级类（表）和教师类（表），一个教师对应一个班级，一个班级也只对应一个教师。<br>　　<br>首先创建表并插入数据：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> teacher(</div><div class="line">	t_id <span class="built_in">INT</span> PRIMARY <span class="keyword">KEY</span> AUTO_INCREMENT, </div><div class="line">	t_name <span class="built_in">VARCHAR</span>(<span class="number">20</span>)</div><div class="line">);</div><div class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="keyword">class</span>(</div><div class="line">	c_id <span class="built_in">INT</span> PRIMARY <span class="keyword">KEY</span> AUTO_INCREMENT, </div><div class="line">	c_name <span class="built_in">VARCHAR</span>(<span class="number">20</span>), </div><div class="line">	teacher_id <span class="built_in">INT</span></div><div class="line">);</div><div class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> <span class="keyword">class</span> <span class="keyword">ADD</span> <span class="keyword">CONSTRAINT</span> fk_teacher_id FOREIGN <span class="keyword">KEY</span> (teacher_id) <span class="keyword">REFERENCES</span> teacher(t_id);	</div><div class="line"></div><div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> teacher(t_name) <span class="keyword">VALUES</span>(<span class="string">'LS1'</span>);</div><div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> teacher(t_name) <span class="keyword">VALUES</span>(<span class="string">'LS2'</span>);</div><div class="line"></div><div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">class</span>(c_name, teacher_id) <span class="keyword">VALUES</span>(<span class="string">'bj_a'</span>, <span class="number">1</span>);</div><div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">class</span>(c_name, teacher_id) <span class="keyword">VALUES</span>(<span class="string">'bj_b'</span>, <span class="number">2</span>);</div></pre></td></tr></table></figure></p>
<p><img src="http://static.zybuluo.com/xiangwanpeng/dye0sp43pqpnlnd2e82e3atk/image_1b4d0n484ohg1bg8m701pkegv59.png" alt="image_1b4d0n484ohg1bg8m701pkegv59.png-15.1kB"></p>
<p><img src="http://static.zybuluo.com/xiangwanpeng/fnbnmsymbozxklpq8ygpkwi3/image_1b4d0ndqt1d001otb3bd1kbo6tfm.png" alt="image_1b4d0ndqt1d001otb3bd1kbo6tfm.png-15.2kB"></p>
<p>其中，class表中的teacher_id是指向teacher表的外键：<br><img src="http://static.zybuluo.com/xiangwanpeng/s15kt7pd7vzj2x2ll5czk8x3/image_1b4d0sebt4d3e9r1fhjgm7e813.png" alt="image_1b4d0sebt4d3e9r1fhjgm7e813.png-17.9kB"></p>
<p>创建实体类：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Teacher</span> </span>&#123;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">int</span> id;</div><div class="line">	<span class="keyword">private</span> String name;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> <span class="string">"Teacher [id="</span> + id + <span class="string">", name="</span> + name + <span class="string">"]"</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Teacher</span><span class="params">(<span class="keyword">int</span> id, String name)</span> </span>&#123;</div><div class="line">		<span class="keyword">super</span>();</div><div class="line">		<span class="keyword">this</span>.id = id;</div><div class="line">		<span class="keyword">this</span>.name = name;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Teacher</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">super</span>();</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Classes</span> </span>&#123;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">int</span> id;</div><div class="line">	<span class="keyword">private</span> String name;</div><div class="line">	<span class="keyword">private</span> Teacher teacher;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> <span class="string">"Classes [id="</span> + id + <span class="string">", name="</span> + name + <span class="string">", teacher="</span> + teacher + <span class="string">"]"</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Classes</span><span class="params">(<span class="keyword">int</span> id, String name, Teacher teacher)</span> </span>&#123;</div><div class="line">		<span class="keyword">super</span>();</div><div class="line">		<span class="keyword">this</span>.id = id;</div><div class="line">		<span class="keyword">this</span>.name = name;</div><div class="line">		<span class="keyword">this</span>.teacher = teacher;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Classes</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">super</span>();</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>主要的处理过程在Classes类的映射文件classesMapper.xml中：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</div><div class="line"><span class="meta">&lt;!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd"&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">"com.mybatis.test5.classesMapper"</span>&gt;</span></div><div class="line">	<span class="comment">&lt;!-- </span></div><div class="line">		根据班级id查询班级信息(带老师的信息)</div><div class="line">		##1. 联表查询</div><div class="line">		SELECT * FROM class c,teacher t WHERE c.teacher_id=t.t_id AND c.c_id=1;</div><div class="line">		</div><div class="line">		##2. 执行两次查询</div><div class="line">		SELECT * FROM class WHERE c_id=1;  //teacher_id=1</div><div class="line">		SELECT * FROM teacher WHERE t_id=1;//使用上面得到的teacher_id</div><div class="line">	 --&gt;</div><div class="line">	 </div><div class="line">	<span class="comment">&lt;!-- </span></div><div class="line">		方式一：嵌套结果：使用嵌套结果映射来处理重复的联合结果的子集</div><div class="line">		         封装联表查询的数据(去除重复的数据)</div><div class="line">		select * from class c, teacher t where c.teacher_id=t.t_id and  c.c_id=1</div><div class="line">	--&gt;</div><div class="line">	<span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"getClassesById"</span> <span class="attr">parameterType</span>=<span class="string">"int"</span> <span class="attr">resultMap</span>=<span class="string">"classesResultMap"</span>&gt;</span></div><div class="line">		select * from class c,teacher t where c.teacher_id=t.t_id and</div><div class="line">		c.c_id=#&#123;id&#125;</div><div class="line">	<span class="tag">&lt;/<span class="name">select</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">resultMap</span> <span class="attr">type</span>=<span class="string">"Classes"</span> <span class="attr">id</span>=<span class="string">"classesResultMap"</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">id</span> <span class="attr">property</span>=<span class="string">"id"</span> <span class="attr">column</span>=<span class="string">"c_id"</span>/&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"name"</span> <span class="attr">column</span>=<span class="string">"c_name"</span>/&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">association</span> <span class="attr">property</span>=<span class="string">"teacher"</span> <span class="attr">javaType</span>=<span class="string">"Teacher"</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">id</span> <span class="attr">property</span>=<span class="string">"id"</span> <span class="attr">column</span>=<span class="string">"t_id"</span>/&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"name"</span> <span class="attr">column</span>=<span class="string">"t_name"</span>/&gt;</span></div><div class="line">	<span class="tag">&lt;/<span class="name">association</span>&gt;</span></div><div class="line">	<span class="tag">&lt;/<span class="name">resultMap</span>&gt;</span></div><div class="line">	</div><div class="line">	<span class="comment">&lt;!-- </span></div><div class="line">	方式二：嵌套查询：通过执行另外一个SQL映射语句来返回预期的复杂类型</div><div class="line">		SELECT * FROM class WHERE c_id=1;</div><div class="line">		SELECT * FROM teacher WHERE t_id=1   //1 是上一个查询得到的teacher_id的值</div><div class="line">	--&gt;</div><div class="line">	<span class="comment">&lt;!-- </span></div><div class="line">	查询所有的班级信息，包括教师信息</div><div class="line">	--&gt;</div><div class="line">	</div><div class="line">	<span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"getAllClasses"</span> <span class="attr">resultMap</span>=<span class="string">"allClassesResultMap"</span>&gt;</span></div><div class="line">	select * from class</div><div class="line">	<span class="tag">&lt;/<span class="name">select</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">resultMap</span> <span class="attr">type</span>=<span class="string">"Classes"</span> <span class="attr">id</span>=<span class="string">"allClassesResultMap"</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">id</span> <span class="attr">property</span>=<span class="string">"id"</span> <span class="attr">column</span>=<span class="string">"c_id"</span>/&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"name"</span> <span class="attr">column</span>=<span class="string">"c_name"</span>/&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">association</span> <span class="attr">property</span>=<span class="string">"teacher"</span> <span class="attr">column</span>=<span class="string">"teacher_id"</span> <span class="attr">select</span>=<span class="string">"getTeacherById"</span>&gt;</span></div><div class="line">	<span class="tag">&lt;/<span class="name">association</span>&gt;</span></div><div class="line">	<span class="tag">&lt;/<span class="name">resultMap</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"getTeacherById"</span> <span class="attr">parameterType</span>=<span class="string">"int"</span> <span class="attr">resultType</span>=<span class="string">"Teacher"</span>&gt;</span></div><div class="line">	select t_name name from teacher where t_id=#&#123;id&#125;</div><div class="line">	<span class="tag">&lt;/<span class="name">select</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>这里介绍了两种方法，第一种是通过联表查询,获取每条class记录执行一次select语句：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> <span class="keyword">class</span> c,teacher t <span class="keyword">WHERE</span> c.teacher_id=t.t_id <span class="keyword">AND</span> c.c_id=?;</div></pre></td></tr></table></figure></p>
<p>另一种方法是通过两次查询，先查找class，再根据查找到的class的teacher_id查询teacher，即获取每条class记录执行两次select语句：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> <span class="keyword">class</span> <span class="keyword">WHERE</span> c_id=?;</div><div class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> teacher <span class="keyword">WHERE</span> t_id=?;</div></pre></td></tr></table></figure></p>
<p>其中的一个重点是resultMap节点中的association节点，它将查询到的列值赋给Classes类的Teacher属性类的对应字段。另外，在第二种方法中，association节点的select属性指定了第二次查询的select节点。<br>association节点的属性如下：</p>
<ul>
<li>property：对象属性的名称</li>
<li>javaType：对象属性的类型</li>
<li>column：对应的外键字段名称</li>
<li>select：使用的另一个查询的id</li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/12/19/用mybatis实现简单的CRUD/" itemprop="url">
                  用mybatis实现简单的CRUD
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-12-19T18:47:44+08:00" content="2016-12-19">
              2016-12-19
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/mybatis/" itemprop="url" rel="index">
                    <span itemprop="name">mybatis</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/12/19/用mybatis实现简单的CRUD/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/12/19/用mybatis实现简单的CRUD/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>　　下面介绍如何用mybatis实现简单的增删改查功能，有两种方式，一种是通过xml配置文件实现，一种是通过注解实现。<br>　　<br>仍然通过对user的操作进行说明，新建好项目并导入jar包后，新建数据库和表，并插入两条记录：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">create</span> <span class="keyword">database</span> mybatis;</div><div class="line"><span class="keyword">use</span> mybatis;</div><div class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="keyword">users</span>(<span class="keyword">id</span> <span class="built_in">INT</span> PRIMARY <span class="keyword">KEY</span> AUTO_INCREMENT, <span class="keyword">NAME</span> <span class="built_in">VARCHAR</span>(<span class="number">20</span>), age <span class="built_in">INT</span>);</div><div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">users</span>(<span class="keyword">NAME</span>, age) <span class="keyword">VALUES</span>(<span class="string">'Tom'</span>, <span class="number">12</span>);</div><div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">users</span>(<span class="keyword">NAME</span>, age) <span class="keyword">VALUES</span>(<span class="string">'Jack'</span>, <span class="number">11</span>);</div></pre></td></tr></table></figure></p>
<p>建表成功：<br><img src="http://static.zybuluo.com/xiangwanpeng/t62zj6z2s26m4vzt2b5x7kni/image_1b4bbvojp1ilqqsu1ad9105783f9.png" alt="image_1b4bbvojp1ilqqsu1ad9105783f9.png-14kB"></p>
<p>新建实体类User.java<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.mybatis.entities;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</div><div class="line">	<span class="keyword">private</span> Integer id;</div><div class="line">	<span class="keyword">private</span> String name;</div><div class="line">	<span class="keyword">private</span> Integer age;</div><div class="line">	</div><div class="line">	<span class="comment">//getters and setters</span></div><div class="line">	</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> <span class="string">"User [id="</span> + id + <span class="string">", name="</span> + name + <span class="string">", age="</span> + age + <span class="string">"]"</span>;</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="通过XML实现"><a href="#通过XML实现" class="headerlink" title="通过XML实现"></a>通过XML实现</h2><p>新建映射文件userMapper.xml：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</div><div class="line"><span class="meta">&lt;!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd"&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">"com.mybatis.test2.userMapper"</span>&gt;</span></div><div class="line"></div><div class="line">	<span class="comment">&lt;!-- 添加操作 --&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">insert</span> <span class="attr">id</span>=<span class="string">"addUser"</span> <span class="attr">parameterType</span>=<span class="string">"com.mybatis.entities.User"</span>&gt;</span></div><div class="line">		insert into users(name,age)</div><div class="line">		values(#&#123;name&#125;,#&#123;age&#125;)</div><div class="line">	<span class="tag">&lt;/<span class="name">insert</span>&gt;</span></div><div class="line">	</div><div class="line">	<span class="comment">&lt;!-- 删除操作 --&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">delete</span> <span class="attr">id</span>=<span class="string">"deleteUser"</span> <span class="attr">parameterType</span>=<span class="string">"int"</span>&gt;</span></div><div class="line">		delete from users where</div><div class="line">		id=#&#123;id&#125;</div><div class="line">	<span class="tag">&lt;/<span class="name">delete</span>&gt;</span></div><div class="line">	</div><div class="line">	<span class="comment">&lt;!-- 更新操作 --&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">update</span> <span class="attr">id</span>=<span class="string">"updateUser"</span> <span class="attr">parameterType</span>=<span class="string">"com.mybatis.entities.User"</span>&gt;</span></div><div class="line">		update users set name = #&#123;name&#125;,age = #&#123;age&#125; where id = #&#123;id&#125;</div><div class="line">	<span class="tag">&lt;/<span class="name">update</span>&gt;</span></div><div class="line">	</div><div class="line">	<span class="comment">&lt;!-- 根据id查找单个记录 --&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"getUserById"</span> <span class="attr">parameterType</span>=<span class="string">"int"</span></span></div><div class="line">		<span class="attr">resultType</span>=<span class="string">"com.mybatis.entities.User"</span>&gt;</div><div class="line">		select *</div><div class="line">		from users where id=#&#123;id&#125;</div><div class="line">	<span class="tag">&lt;/<span class="name">select</span>&gt;</span></div><div class="line">	</div><div class="line">	<span class="comment">&lt;!-- 查找所有记录 --&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"getAllUsers"</span> <span class="attr">resultType</span>=<span class="string">"com.mybatis.entities.User"</span>&gt;</span></div><div class="line">		select * from users</div><div class="line">	<span class="tag">&lt;/<span class="name">select</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>在mybatis配置文件中注册上述映射文件：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">mappers</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">mapper</span> <span class="attr">resource</span>=<span class="string">"com/mybatis/test2/userMapper.xml"</span> /&gt;</span></div><div class="line">	<span class="tag">&lt;/<span class="name">mappers</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>编写测试类进行测试：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</div><div class="line">	</div><div class="line">	<span class="keyword">private</span> SqlSessionFactory sessionFactory;</div><div class="line">	<span class="keyword">private</span> SqlSession session;</div><div class="line"></div><div class="line">	<span class="meta">@Before</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span></span>&#123;</div><div class="line">		<span class="comment">//读取配置文件</span></div><div class="line">        String resource = <span class="string">"conf.xml"</span>;</div><div class="line">        InputStream is = <span class="keyword">this</span>.getClass().getClassLoader().getResourceAsStream(resource);</div><div class="line"></div><div class="line">        <span class="comment">//创建SqlSessionFactory和SqlSession</span></div><div class="line">        sessionFactory = <span class="keyword">new</span> SqlSessionFactoryBuilder().build(is);</div><div class="line">        session = sessionFactory.openSession();</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	<span class="meta">@After</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">free</span><span class="params">()</span></span>&#123;</div><div class="line">		session.commit();</div><div class="line">		session.close();</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	<span class="meta">@org</span>.junit.<span class="function">Test</span></div><div class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testAddUser</span><span class="params">()</span> &#123;</div><div class="line">        String statement = <span class="string">"com.mybatis.test2.userMapper"</span>+<span class="string">".addUser"</span>;</div><div class="line">        User user = <span class="keyword">new</span> User(-<span class="number">1</span>, <span class="string">"Alan"</span>, <span class="number">25</span>);</div><div class="line">        session.insert(statement, user);</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	<span class="meta">@org</span>.junit.<span class="function">Test</span></div><div class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testDeleteUser</span><span class="params">()</span> &#123;</div><div class="line">        String statement = <span class="string">"com.mybatis.test2.userMapper"</span>+<span class="string">".deleteUser"</span>;</div><div class="line">        session.delete(statement, <span class="number">3</span>);</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	<span class="meta">@org</span>.junit.<span class="function">Test</span></div><div class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testUpdateUser</span><span class="params">()</span> &#123;</div><div class="line">        String statement = <span class="string">"com.mybatis.test2.userMapper"</span>+<span class="string">".updateUser"</span>;</div><div class="line">        User user = <span class="keyword">new</span> User(<span class="number">2</span>,<span class="string">"Jim"</span>,<span class="number">19</span>);</div><div class="line">        session.update(statement, user);</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	<span class="meta">@org</span>.junit.<span class="function">Test</span></div><div class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testgetUserById</span><span class="params">()</span> &#123;</div><div class="line">        String statement = <span class="string">"com.mybatis.test2.userMapper"</span>+<span class="string">".getUserById"</span>;</div><div class="line">        User user = session.selectOne(statement, <span class="number">1</span>);</div><div class="line">        System.out.println(user);</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	<span class="meta">@org</span>.junit.<span class="function">Test</span></div><div class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testgetAllUsers</span><span class="params">()</span> &#123;</div><div class="line">        String statement = <span class="string">"com.mybatis.test2.userMapper"</span>+<span class="string">".getAllUsers"</span>;</div><div class="line">        List&lt;User&gt; list = session.selectList(statement);</div><div class="line">        System.out.println(list);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>注意点:</p>
<ol>
<li>在映射文件中，当parameterType=”int”时，sql语句中的参数名可以随便定义，例如#{id}，#{_id}都可以；但是当parameterType=”com.mybatis.entities.User”时，sql语句中的参数名需要和User类中的对应字段名一致，例如#{id}对应User类中的字段id，而不能写成#{_id}。</li>
<li>在映射文件中定义getAllUsers时，只需要指明返回的集合中的元素的类型，即仅需要指明resultType=”com.mybatis.entities.User”就可以了。</li>
</ol>
<h2 id="通过注解实现"><a href="#通过注解实现" class="headerlink" title="通过注解实现"></a>通过注解实现</h2><p>新建接口UserMapper.java：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserMapper</span> </span>&#123;</div><div class="line">	<span class="meta">@Insert</span>(<span class="string">"insert into users(name,age) values(#&#123;name&#125;,#&#123;age&#125;)"</span>)</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">addUser</span><span class="params">(User user)</span></span>;</div><div class="line"></div><div class="line">	<span class="meta">@Delete</span>(<span class="string">"delete from users where id=#&#123;id&#125;"</span>)</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">deleteUser</span><span class="params">(<span class="keyword">int</span> id)</span></span>;</div><div class="line"></div><div class="line">	<span class="meta">@Update</span>(<span class="string">"update users set name=#&#123;name&#125;,age=#&#123;age&#125; where id=#&#123;id&#125;"</span>)</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">updateUser</span><span class="params">(User user)</span></span>;</div><div class="line"></div><div class="line">	<span class="meta">@Select</span>(<span class="string">"select * from users where id=#&#123;id&#125;"</span>)</div><div class="line">	<span class="function"><span class="keyword">public</span> User <span class="title">getUserById</span><span class="params">(<span class="keyword">int</span> id)</span></span>;</div><div class="line"></div><div class="line">	<span class="meta">@Select</span>(<span class="string">"select * from users"</span>)</div><div class="line">	<span class="function"><span class="keyword">public</span> List&lt;User&gt; <span class="title">getAllUsers</span><span class="params">()</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在mybatis配置文件中注册该接口：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">mappers</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">mapper</span> <span class="attr">class</span>=<span class="string">"com.mybatis.test3.UserMapper"</span>/&gt;</span></div><div class="line">	<span class="tag">&lt;/<span class="name">mappers</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>编写测试列进行测试：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</div><div class="line">	</div><div class="line">	<span class="keyword">private</span> SqlSessionFactory sessionFactory;</div><div class="line">	<span class="keyword">private</span> SqlSession session;</div><div class="line">	<span class="keyword">private</span> UserMapper userMapper;</div><div class="line"></div><div class="line">	<span class="meta">@Before</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span></span>&#123;</div><div class="line">		<span class="comment">//读取配置文件</span></div><div class="line">        String resource = <span class="string">"conf.xml"</span>;</div><div class="line">        InputStream is = <span class="keyword">this</span>.getClass().getClassLoader().getResourceAsStream(resource);</div><div class="line"></div><div class="line">        <span class="comment">//创建SqlSessionFactory和SqlSession</span></div><div class="line">        sessionFactory = <span class="keyword">new</span> SqlSessionFactoryBuilder().build(is);</div><div class="line">        session = sessionFactory.openSession();</div><div class="line">        </div><div class="line">        <span class="comment">//获取UserMapper</span></div><div class="line">        userMapper = session.getMapper(UserMapper.class);</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	<span class="meta">@After</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">free</span><span class="params">()</span></span>&#123;</div><div class="line">		session.commit();</div><div class="line">		session.close();</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	<span class="meta">@org</span>.junit.<span class="function">Test</span></div><div class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testAddUser</span><span class="params">()</span> &#123;</div><div class="line">        User user = <span class="keyword">new</span> User(-<span class="number">1</span>, <span class="string">"Alan"</span>, <span class="number">25</span>);</div><div class="line">        userMapper.addUser(user);</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	<span class="meta">@org</span>.junit.<span class="function">Test</span></div><div class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testDeleteUser</span><span class="params">()</span> &#123;</div><div class="line">		userMapper.deleteUser(<span class="number">9</span>);</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	<span class="meta">@org</span>.junit.<span class="function">Test</span></div><div class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testUpdateUser</span><span class="params">()</span> &#123;</div><div class="line">        User user = <span class="keyword">new</span> User(<span class="number">2</span>,<span class="string">"Jim"</span>,<span class="number">19</span>);</div><div class="line">        userMapper.updateUser(user);</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	<span class="meta">@org</span>.junit.<span class="function">Test</span></div><div class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testgetUserById</span><span class="params">()</span> &#123;</div><div class="line">        User user = userMapper.getUserById(<span class="number">1</span>);</div><div class="line">        System.out.println(user);</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	<span class="meta">@org</span>.junit.<span class="function">Test</span></div><div class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testgetAllUsers</span><span class="params">()</span> &#123;</div><div class="line">        List&lt;User&gt; list = userMapper.getAllUsers();</div><div class="line">        System.out.println(list);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="可以优化的地方"><a href="#可以优化的地方" class="headerlink" title="可以优化的地方"></a>可以优化的地方</h2><p>一、连接数据库的配置单独放在一个properties文件中：</p>
<p>新建配置文件db.properties：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">driver=com.mysql.jdbc.Driver</div><div class="line">url=jdbc:mysql://localhost:3306/mybatis</div><div class="line">name=你的数据库用户名</div><div class="line">password=你的数据库密码</div></pre></td></tr></table></figure></p>
<p>在mybatis配置文件中配置：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</div><div class="line"><span class="meta">&lt;!DOCTYPE configuration PUBLIC "-//mybatis.org//DTD Config 3.0//EN" "http://mybatis.org/dtd/mybatis-3-config.dtd"&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></div><div class="line"></div><div class="line">	<span class="tag">&lt;<span class="name">properties</span> <span class="attr">resource</span>=<span class="string">"db.properties"</span>/&gt;</span></div><div class="line">	</div><div class="line">	<span class="tag">&lt;<span class="name">environments</span> <span class="attr">default</span>=<span class="string">"development"</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">environment</span> <span class="attr">id</span>=<span class="string">"development"</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">transactionManager</span> <span class="attr">type</span>=<span class="string">"JDBC"</span> /&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">dataSource</span> <span class="attr">type</span>=<span class="string">"POOLED"</span>&gt;</span></div><div class="line">				<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"driver"</span> <span class="attr">value</span>=<span class="string">"$&#123;driver&#125;"</span> /&gt;</span></div><div class="line">				<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"url"</span> <span class="attr">value</span>=<span class="string">"$&#123;url&#125;"</span> /&gt;</span></div><div class="line">				<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"username"</span> <span class="attr">value</span>=<span class="string">"$&#123;name&#125;"</span> /&gt;</span></div><div class="line">				<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"password"</span> <span class="attr">value</span>=<span class="string">"$&#123;password&#125;"</span> /&gt;</span></div><div class="line">			<span class="tag">&lt;/<span class="name">dataSource</span>&gt;</span></div><div class="line">		<span class="tag">&lt;/<span class="name">environment</span>&gt;</span></div><div class="line">	<span class="tag">&lt;/<span class="name">environments</span>&gt;</span></div><div class="line">	</div><div class="line">	<span class="tag">&lt;<span class="name">mappers</span>&gt;</span></div><div class="line">	...</div><div class="line">	<span class="tag">&lt;/<span class="name">mappers</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>二、 可以为实体类定义别名，以简化映射文件中的引用：</p>
<p>在mybatis配置文件的configuration节点下配置：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">typeAliases</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">typeAlias</span> <span class="attr">type</span>=<span class="string">"com.mybatis.entities.User"</span> <span class="attr">alias</span>=<span class="string">"User"</span>/&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">typeAliases</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>那么，当要在映射文件引用User类的全类名时，只需要使用”User”即可，例如：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!-- 添加操作 --&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">insert</span> <span class="attr">id</span>=<span class="string">"addUser"</span> <span class="attr">parameterType</span>=<span class="string">"User"</span>&gt;</span></div><div class="line">		insert into users(name,age)</div><div class="line">		values(#&#123;name&#125;,#&#123;age&#125;)</div><div class="line">	<span class="tag">&lt;/<span class="name">insert</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>当要定义别名的类比较多时，还有一种更方便的方法，在mybatis配置文件的configuration节点下配置：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">typeAliases</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">package</span> <span class="attr">name</span>=<span class="string">"com.mybatis.entities"</span>/&gt;</span></div><div class="line">	<span class="tag">&lt;/<span class="name">typeAliases</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>这将声明在映射文件中，包com.mybatis.entities下的所有类都可以用简单类名来替代全类名。</p>
<p>三、可以在src下加入log4j的配置文件，打印日志信息：</p>
<p>首先需要先导入log4j的jar包：</p>
<p><img src="http://static.zybuluo.com/xiangwanpeng/66b8rsz4n51a99plg1a4y0no/image_1b4br2p5dqlm1urr5531d9q1g4o9.png" alt="image_1b4br2p5dqlm1urr5531d9q1g4o9.png-3.5kB"></p>
<p>然后配置log4j，有两种方法：</p>
<p>方法一、在src目录下新建log4j.properties：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">log4j.properties，</div><div class="line">log4j.rootLogger=DEBUG, Console</div><div class="line">#Console</div><div class="line">log4j.appender.Console=org.apache.log4j.ConsoleAppender</div><div class="line">log4j.appender.Console.layout=org.apache.log4j.PatternLayout</div><div class="line">log4j.appender.Console.layout.ConversionPattern=%d [%t] %-5p [%c] - %m%n</div><div class="line">log4j.logger.java.sql.ResultSet=INFO</div><div class="line">log4j.logger.org.apache=INFO</div><div class="line">log4j.logger.java.sql.Connection=DEBUG</div><div class="line">log4j.logger.java.sql.Statement=DEBUG</div><div class="line">log4j.logger.java.sql.PreparedStatement=DEBUG</div></pre></td></tr></table></figure></p>
<p>方法二、在src目录下新建log4j.xml：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</div><div class="line"><span class="meta">&lt;!DOCTYPE log4j:configuration SYSTEM "log4j.dtd"&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">log4j:configuration</span> <span class="attr">xmlns:log4j</span>=<span class="string">"http://jakarta.apache.org/log4j/"</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">"STDOUT"</span> <span class="attr">class</span>=<span class="string">"org.apache.log4j.ConsoleAppender"</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">layout</span> <span class="attr">class</span>=<span class="string">"org.apache.log4j.PatternLayout"</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">param</span> <span class="attr">name</span>=<span class="string">"ConversionPattern"</span> <span class="attr">value</span>=<span class="string">"%-5p %d&#123;MM-dd HH:mm:ss,SSS&#125; %m  (%F:%L) \n"</span> /&gt;</span></div><div class="line">		<span class="tag">&lt;/<span class="name">layout</span>&gt;</span></div><div class="line">	<span class="tag">&lt;/<span class="name">appender</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">logger</span> <span class="attr">name</span>=<span class="string">"java.sql"</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">level</span> <span class="attr">value</span>=<span class="string">"debug"</span> /&gt;</span></div><div class="line">	<span class="tag">&lt;/<span class="name">logger</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">logger</span> <span class="attr">name</span>=<span class="string">"org.apache.ibatis"</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">level</span> <span class="attr">value</span>=<span class="string">"debug"</span> /&gt;</span></div><div class="line">	<span class="tag">&lt;/<span class="name">logger</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">root</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">level</span> <span class="attr">value</span>=<span class="string">"debug"</span> /&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">"STDOUT"</span> /&gt;</span></div><div class="line">	<span class="tag">&lt;/<span class="name">root</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">log4j:configuration</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>然后当执行sql操作时就会在控制台打印sql语句。</p>
<h2 id="解决字段名与实体类属性名不相同的冲突"><a href="#解决字段名与实体类属性名不相同的冲突" class="headerlink" title="解决字段名与实体类属性名不相同的冲突"></a>解决字段名与实体类属性名不相同的冲突</h2><p>　　在上面的例子中，我们在映射文件中按一下方式定义select操作时：<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&lt;select id="getUserById" parameterType="int"</div><div class="line">		resultType="User"&gt;</div><div class="line">		select *</div><div class="line">		from users where id=#&#123;id&#125;</div><div class="line">	&lt;/select&gt;</div></pre></td></tr></table></figure></p>
<p>之所以能够查找成功并成功返回一个User对象，是因为实体类User的字段名和表users的列名完全一致：</p>
<p>User类：<br><img src="http://static.zybuluo.com/xiangwanpeng/517xyyfxamu7mbhqp690qje7/image_1b4bsgsuo1skrrcgp711djtr213.png" alt="image_1b4bsgsuo1skrrcgp711djtr213.png-4.7kB"></p>
<p>users表：<br><img src="http://static.zybuluo.com/xiangwanpeng/g550o88evdxanldzj6ghb7az/image_1b4bsjji91o9t1pd01rp47oi11s71t.png" alt="image_1b4bsjji91o9t1pd01rp47oi11s71t.png-6.5kB"></p>
<p>当它们不一致时，就无法通过这种方式达到预期的效果。这个问题有两种解决办法，为了进行说明，我们先定义列名和字段名不一致的表orders和类Order：<br>　　<br>新建表，并插入三条记录：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> orders(</div><div class="line">	order_id <span class="built_in">INT</span> PRIMARY <span class="keyword">KEY</span> AUTO_INCREMENT,</div><div class="line">	order_no <span class="built_in">VARCHAR</span>(<span class="number">20</span>), </div><div class="line">	order_price <span class="built_in">FLOAT</span></div><div class="line">);</div><div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> orders(order_no, order_price) <span class="keyword">VALUES</span>(<span class="string">'aaaa'</span>, <span class="number">23</span>);</div><div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> orders(order_no, order_price) <span class="keyword">VALUES</span>(<span class="string">'bbbb'</span>, <span class="number">33</span>);</div><div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> orders(order_no, order_price) <span class="keyword">VALUES</span>(<span class="string">'cccc'</span>, <span class="number">22</span>);</div></pre></td></tr></table></figure></p>
<p><img src="http://static.zybuluo.com/xiangwanpeng/njwkms11iruvzte32j4y5l20/image_1b4bs0168efh1v42ohqlj414fum.png" alt="image_1b4bs0168efh1v42ohqlj414fum.png-10.4kB"></p>
<p>新建实体类：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Order</span> </span>&#123;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">int</span> id;</div><div class="line">	<span class="keyword">private</span> String orderNo;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">float</span> price;</div><div class="line">	</div><div class="line">	<span class="comment">//getters and setters</span></div><div class="line">	</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> <span class="string">"Order [id="</span> + id + <span class="string">", orderNo="</span> + orderNo + <span class="string">", price="</span> + price + <span class="string">"]"</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Order</span><span class="params">(<span class="keyword">int</span> id, String orderNo, <span class="keyword">float</span> price)</span> </span>&#123;</div><div class="line">		<span class="keyword">super</span>();</div><div class="line">		<span class="keyword">this</span>.id = id;</div><div class="line">		<span class="keyword">this</span>.orderNo = orderNo;</div><div class="line">		<span class="keyword">this</span>.price = price;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Order</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">super</span>();</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>　　在这个例子中，orders表的列为order_id，order_no，order_price，Order类的对应字段名分别为id，orderNo，price，解决方法如下：<br>　　<br>方法一、通过在映射文件的sql语句中定义别名：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"getOrder"</span> <span class="attr">parameterType</span>=<span class="string">"int"</span> <span class="attr">resultType</span>=<span class="string">"Order"</span>&gt;</span></div><div class="line">		select order_no orderNo,order_price price from orders where order_id=#&#123;id&#125;</div><div class="line">	<span class="tag">&lt;/<span class="name">select</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>方法二: 通过映射文件中节点的resultMap属性：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"getAllOrders"</span> <span class="attr">resultMap</span>=<span class="string">"orderResultMap"</span>&gt;</span></div><div class="line">		select * from orders</div><div class="line">	<span class="tag">&lt;/<span class="name">select</span>&gt;</span></div><div class="line">	</div><div class="line">	<span class="tag">&lt;<span class="name">resultMap</span> <span class="attr">type</span>=<span class="string">"Order"</span> <span class="attr">id</span>=<span class="string">"orderResultMap"</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">id</span> <span class="attr">property</span>=<span class="string">"id"</span> <span class="attr">column</span>=<span class="string">"order_id"</span> /&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"orderNo"</span> <span class="attr">column</span>=<span class="string">"order_no"</span> /&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"price"</span> <span class="attr">column</span>=<span class="string">"order_price"</span>/&gt;</span></div><div class="line">	<span class="tag">&lt;/<span class="name">resultMap</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>其中，select节点中的resultMap需要和resultMap节点的id对应。在resultMap节点下，主键使用id节点，普通属性使用result节点，其中property指实体类中的字段名，column指数据库表中对应的列名。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/12/19/mybatis快速入门/" itemprop="url">
                  mybatis快速入门
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-12-19T09:54:39+08:00" content="2016-12-19">
              2016-12-19
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/mybatis/" itemprop="url" rel="index">
                    <span itemprop="name">mybatis</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/12/19/mybatis快速入门/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/12/19/mybatis快速入门/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Mybatis简介"><a href="#Mybatis简介" class="headerlink" title="Mybatis简介"></a>Mybatis简介</h2><p>　　MyBatis是支持普通SQL查询，存储过程和高级映射的优秀持久层框架。MyBatis消除了几乎所有的JDBC代码和参数的手工设置以及对结果集的检索封装。MyBatis可以使用简单的XML或注解用于配置和原始映射，将接口和Java的POJO（Plain Old Java Objects，普通的Java对象）映射成数据库中的记录。
　　</p>
<h2 id="Mybatis快速入门"><a href="#Mybatis快速入门" class="headerlink" title="Mybatis快速入门"></a>Mybatis快速入门</h2><p>下面写一个简单的测试例子，首先新建一个project，导入mybatis核心jar包和mysql驱动jar包：<br><img src="http://static.zybuluo.com/xiangwanpeng/77aejqsztdunrra5x5bb8r6h/image_1b4adm56plbu1d1bgvv8p21fdu9.png" alt="image_1b4adm56plbu1d1bgvv8p21fdu9.png-4.6kB"></p>
<p>新建数据库和表，并插入两条记录：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">create</span> <span class="keyword">database</span> mybatis;</div><div class="line"><span class="keyword">use</span> mybatis;</div><div class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="keyword">users</span>(<span class="keyword">id</span> <span class="built_in">INT</span> PRIMARY <span class="keyword">KEY</span> AUTO_INCREMENT, <span class="keyword">NAME</span> <span class="built_in">VARCHAR</span>(<span class="number">20</span>), age <span class="built_in">INT</span>);</div><div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">users</span>(<span class="keyword">NAME</span>, age) <span class="keyword">VALUES</span>(<span class="string">'Tom'</span>, <span class="number">12</span>);</div><div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">users</span>(<span class="keyword">NAME</span>, age) <span class="keyword">VALUES</span>(<span class="string">'Jack'</span>, <span class="number">11</span>);</div></pre></td></tr></table></figure></p>
<p>建表成功：<br><img src="http://static.zybuluo.com/xiangwanpeng/2ldn8a5w85ivqowzr5t6x52t/image_1b4aeseal1l64lvmiht1b391ns913.png" alt="image_1b4aeseal1l64lvmiht1b391ns913.png-14kB"></p>
<p>新建实体类User.java<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.mybatis.entities;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</div><div class="line">	<span class="keyword">private</span> Integer id;</div><div class="line">	<span class="keyword">private</span> String name;</div><div class="line">	<span class="keyword">private</span> Integer age;</div><div class="line">	</div><div class="line">	<span class="comment">//getters and setters</span></div><div class="line">	</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> <span class="string">"User [id="</span> + id + <span class="string">", name="</span> + name + <span class="string">", age="</span> + age + <span class="string">"]"</span>;</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>新建实体类的映射文件userMapper.xml<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</div><div class="line"><span class="meta">&lt;!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd"&gt;</span> </div><div class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">"com.mybatis.entities.userMapper"</span>&gt;</span> </div><div class="line">	<span class="comment">&lt;!-- 定义一个查询，根据id查询到一条users记录 --&gt;</span></div><div class="line">	<span class="comment">&lt;!-- parameterType指定sql语句的#&#123;id&#125;中id类型为int --&gt;</span></div><div class="line">	<span class="comment">&lt;!-- resultType指定将查询结果封装到一个User类中进行返回 --&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"getUser"</span> <span class="attr">parameterType</span>=<span class="string">"int"</span> </span></div><div class="line">		<span class="attr">resultType</span>=<span class="string">"com.mybatis.entities.User"</span>&gt;</div><div class="line">		select * from users where id=#&#123;id&#125;</div><div class="line">	<span class="tag">&lt;/<span class="name">select</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>在src目录下新建mybatis配置文件conf.xml：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</div><div class="line"><span class="meta">&lt;!DOCTYPE configuration PUBLIC "-//mybatis.org//DTD Config 3.0//EN" "http://mybatis.org/dtd/mybatis-3-config.dtd"&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></div><div class="line">　　</div><div class="line">　　<span class="comment">&lt;!-- 可选development：开发模式，work：工作模式 --&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">environments</span> <span class="attr">default</span>=<span class="string">"development"</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">environment</span> <span class="attr">id</span>=<span class="string">"development"</span>&gt;</span></div><div class="line">		</div><div class="line">		　　<span class="comment">&lt;!-- 事务管理，使用JDBC的提交和回滚设置 --&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">transactionManager</span> <span class="attr">type</span>=<span class="string">"JDBC"</span> /&gt;</span></div><div class="line">			</div><div class="line">			<span class="comment">&lt;!-- 配置数据源，使用连接池 --&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">dataSource</span> <span class="attr">type</span>=<span class="string">"POOLED"</span>&gt;</span></div><div class="line">				<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"driver"</span> <span class="attr">value</span>=<span class="string">"com.mysql.jdbc.Driver"</span> /&gt;</span></div><div class="line">				<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"url"</span> <span class="attr">value</span>=<span class="string">"jdbc:mysql://localhost:3306/mybatis"</span> /&gt;</span></div><div class="line">				<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"username"</span> <span class="attr">value</span>=<span class="string">"你的数据库用户名"</span> /&gt;</span></div><div class="line">				<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"password"</span> <span class="attr">value</span>=<span class="string">"你的数据库密码"</span> /&gt;</span></div><div class="line">			<span class="tag">&lt;/<span class="name">dataSource</span>&gt;</span></div><div class="line">			</div><div class="line">		<span class="tag">&lt;/<span class="name">environment</span>&gt;</span></div><div class="line">	<span class="tag">&lt;/<span class="name">environments</span>&gt;</span></div><div class="line">	</div><div class="line">	<span class="comment">&lt;!-- 注册映射文件 --&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">mappers</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">mapper</span> <span class="attr">resource</span>=<span class="string">"com/mybatis/entities/userMapper.xml"</span>/&gt;</span></div><div class="line">	<span class="tag">&lt;/<span class="name">mappers</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>测试：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="meta">@org</span>.junit.<span class="function">Test</span></div><div class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> &#123;</div><div class="line">		<span class="comment">//读取配置文件</span></div><div class="line">		String resource = <span class="string">"conf.xml"</span>;</div><div class="line">		InputStream is = <span class="keyword">this</span>.getClass().getClassLoader().getResourceAsStream(resource);</div><div class="line">		</div><div class="line">		<span class="comment">//创建SqlSessionFactory和SqlSession</span></div><div class="line">		SqlSessionFactory sessionFactory = <span class="keyword">new</span> SqlSessionFactoryBuilder().build(is);</div><div class="line">		SqlSession session = sessionFactory.openSession();</div><div class="line">		</div><div class="line">		<span class="comment">//映射sql的标识字符串</span></div><div class="line">		<span class="comment">//com.mybatis.entities.userMapper对应映射文件中的namespace</span></div><div class="line">        <span class="comment">//getUser对应映射文件中的select标签的id</span></div><div class="line">		String statement = <span class="string">"com.mybatis.entities.userMapper"</span>+<span class="string">".getUser"</span>;</div><div class="line">		<span class="comment">//执行查询返回id为1的记录</span></div><div class="line">		User user = session.selectOne(statement, <span class="number">1</span>);</div><div class="line">		System.out.println(user);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>运行结果如下图所示：<br><img src="http://static.zybuluo.com/xiangwanpeng/1anbc0xh4qszbx88atdhvj8q/image_1b4agku565uour7v9ub851m4q1g.png" alt="image_1b4agku565uour7v9ub851m4q1g.png-5.2kB"></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/12/18/Linux基本命令/" itemprop="url">
                  Linux基本命令
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-12-18T23:24:04+08:00" content="2016-12-18">
              2016-12-18
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/12/18/Linux基本命令/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/12/18/Linux基本命令/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/12/08/Hibernate管理Session和批量操作/" itemprop="url">
                  Hibernate管理Session和批量操作
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-12-08T12:36:37+08:00" content="2016-12-08">
              2016-12-08
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/12/08/Hibernate管理Session和批量操作/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/12/08/Hibernate管理Session和批量操作/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="管理Session"><a href="#管理Session" class="headerlink" title="管理Session"></a>管理Session</h2><p>　　Hibernate自身提供了三种管理Session对象的方法：<br>　　<strong>① Session对象的生命周期与本地线程绑定</strong><br>　　② Session对象的生命周期与JTA事务绑定<br>　　③ Hibernate委托程序管理Session对象的生命周期<br>　　<br>　　在Hibernate的配置文件中，hibernate.current_session_context_class属性用于指定Session管理方式，可选值包括：<br>　　<strong>thread：</strong> Session对象的生命周期与本地线程绑定<br>　　<strong>jta*：</strong> Session对象的生命周期与JTA事务绑定<br>　　<strong>managed：</strong> Hibernate委托程序来管理Session对象的生命周期<br>　　<br>　　现在介绍第一种管理方式，即将Session对象的生命周期与本地线程绑定。<br>　　如果把Hibernate配置文件的hibernate.current_session_context_class属性设置为thread，Hibernate就会按照与本地线程绑定的方式来管理Session。<br>　　<br>　　Hibernate按以下规则把Session与本地线程绑定：<br>　　当一个线程（threadA）第一次调用SessionFactory的<strong>getCurrentSession()</strong>方法时，该方法会创建一个新的Session（sessionA）对象，把该对象与threadA绑定，并将sessionA返回。<br>　　当threadA再次调用SessionFactory对象的getCurrentSession()方法时，该方法将返回sessionA对象。<br>　　当threadA提交sessionA对象关联的事务时，Hibernate会自动flush sessionA对象的缓存，然后提交事务，<strong>关闭sessionA对象</strong>。当threadA撤销sessionA关联的事务时，<strong>也会自动关闭sessionA对象</strong>。<br>　　若threadA再次调用SessionFactory对象的getCurrentSession()方法时，该方法<strong>会创建一个新的Session(sessionB)对象</strong>，把该对象与threadA绑定，并将sessionB返回。
　　</p>
<h2 id="批量处理"><a href="#批量处理" class="headerlink" title="批量处理"></a>批量处理</h2><p>　　批量处理数据是指在一个事务中处理大量数据。<br>　　在应用层进行批量操作，主要有以下方式：<br>　　1.通过Session<br>　　2.通过HQL<br>　　3.通过StatelessSession<br>　　4.<strong>通过JDBC API</strong>（推荐方式，效率最高）<br>　　<br><strong>通过Session进行批量操作：</strong><br>　　Session的save()及update()方法都会把处理的对象存放在自己的缓存中。如果通过一个Session对象来处理大量持久化对象，应该<strong>及时从缓存中清空已经处理完毕并且不会再访问的对象</strong>。具体的做法是在<strong>处理完一个对象或小批量对象后，立即调用flush()方法刷新缓存，然后再调用clear()方法情况缓存。</strong><br>　　通过Session来进行处理操作会受到以下约束：<br>　　1.需要在Hibernate配置文件中设置JDBC单次批量处理的数目，应保证每次向数据库发送的批量的SQL语句数目与batch size属性一致。<br>　　2.若对象采用”identity”标识生成器，则Hibernate无法在JDBC曾进行批量插入操作<br>　　3.进行批量操作时，建议关闭Hibernate的二级缓存</p>
<p>下面的代码演示了通过session批量插入数据：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">News news = <span class="keyword">null</span>;</div><div class="line"> <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10000</span>; i++) &#123;</div><div class="line">     news = <span class="keyword">new</span> News();</div><div class="line">     news.setTitle(<span class="string">"--"</span> + i);</div><div class="line"></div><div class="line">    session.save(news);</div><div class="line">     <span class="keyword">if</span>((i + <span class="number">1</span>) % <span class="number">20</span> == <span class="number">0</span>) &#123;</div><div class="line">         session.flush();</div><div class="line">         session.clear();</div><div class="line">     &#125;</div><div class="line"> &#125;</div></pre></td></tr></table></figure></p>
<p>　　对于批量更新，在进行批量更新时，如果一下子把所有对象都加载到Session缓存，然后在缓存中一一更新，显然是不可取的。<br>　　使用可滚动的结果集org.hibernate.ScrollableResults,该对象中实际上并不包含任何对象，只包含用于在线定位记录的游标。只有当程序遍历访问ScrollableResults对象的特定元素时，它才会到数据库中加载相应的对象。<br>　　org.hibernate.ScrollableResults对象由Query的scroll方法返回。<br>　　代码如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">ScrollableResults sr = session.createQuery(<span class="string">"FROM News"</span>).scroll();</div><div class="line"></div><div class="line">		<span class="keyword">int</span> count = <span class="number">0</span>;</div><div class="line">		<span class="keyword">while</span> (sr.next()) &#123;</div><div class="line">			News n = (News) sr.get(<span class="number">0</span>);</div><div class="line">			n.setTitle(n.getTitle() + <span class="string">"*****"</span>);</div><div class="line"></div><div class="line">			<span class="keyword">if</span> (((count++) + <span class="number">1</span>) % <span class="number">100</span> == <span class="number">0</span>) &#123;</div><div class="line">				session.flush();</div><div class="line">				session.clear();</div><div class="line">			&#125;</div><div class="line">		&#125;</div></pre></td></tr></table></figure></p>
<p><strong>通过HQL进行批量操作：</strong></p>
<p>注意：HQL只支持INSERT INTO … SELECT形式的插入语句，但不支持INSERT INTO … VALUES形式的插入语句，所以使用HQL不能进行批量插入操作。</p>
<p><strong>通过StatelessSession进行批量操作：</strong></p>
<p>从形式上看，StatelessSession与Session的用法类似。StatelessSession与Session相比，有以下区别：<br>　　StatelessSession没有缓存，通过StatelessSession来加载、保存或更新后的对象处于游离状态.<br>　　StatelessSession不会与Hibernate的二级缓存交互。<br>　　当调用StatelessSession的save()、update()或delete()方法时，这些方法会立即执行相应的SQL语句，而不会仅计划执行一条SQL语句。<br>　　StatelessSession不会进行脏检查，因此修改了Customer对象属性后，还需要调用StatelessSession的update()方法来更新数据库中数据。<br>　　StatelessSession不会对关联的对象进行任何的级联操作。<br>　　通过同一个StatelessSession对象两次加载的OID为1的Customer对象，得到的两个对象内存地址不同。<br>　　StatelessSession所做的操作可以被Interceptor拦截器捕获到，但是会被Hibernate的事件处理系统忽略掉。<br>　　<br><strong>通过JDBC API执行批量操作：（推荐）</strong><br>　　这是效率最高的方法，代码如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">public void testBatch() &#123;</div><div class="line">	session.doWork(new Work() &#123;</div><div class="line">		@Override</div><div class="line">		public void execute(Connection connection) throws SQLException &#123;</div><div class="line">			// 通过 JDBC 原生的 API 进行操作, 效率最高, 速度最快!</div><div class="line">		&#125;</div><div class="line">	&#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/12/08/Hibernate二级缓存——SessionFactory/" itemprop="url">
                  Hibernate二级缓存——SessionFactory
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-12-08T00:03:43+08:00" content="2016-12-08">
              2016-12-08
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Hibernate/" itemprop="url" rel="index">
                    <span itemprop="name">Hibernate</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/12/08/Hibernate二级缓存——SessionFactory/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/12/08/Hibernate二级缓存——SessionFactory/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Hibernate二级缓存简介"><a href="#Hibernate二级缓存简介" class="headerlink" title="Hibernate二级缓存简介"></a>Hibernate二级缓存简介</h2><p>　　在<a href="http://blog.csdn.net/xiangwanpeng/article/details/53443781" target="_blank" rel="external">《Hibernate一级缓存——Session》</a>中介绍了Session级别的一级缓存，例如，当如下的代码执行时，由于一级缓存的作用，只会发送一条select语句：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Test</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testCache</span><span class="params">()</span></span>&#123;</div><div class="line">		</div><div class="line">		Employee employee1 = (Employee) session.get(Employee.class, <span class="number">1</span>);</div><div class="line">		System.out.println(employee1);</div><div class="line">		</div><div class="line">		Employee employee2 = (Employee) session.get(Employee.class, <span class="number">1</span>);</div><div class="line">		System.out.println(employee2);</div><div class="line">	&#125;</div></pre></td></tr></table></figure></p>
<p><img src="http://static.zybuluo.com/xiangwanpeng/av7uolxrylvwm0bnyyok1w52/image_1b3e0uaih1m5o1oqu1q3g18r1ksc13.png" alt="image_1b3e0uaih1m5o1oqu1q3g18r1ksc13.png-19kB"></p>
<p>　　现在，我们在两次加载代码之间，先关闭当前的session和事务，再重新开启一个session和事务，那么不难理解，由于开启了新的session，所以会打印两条select语句：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Test</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testCache</span><span class="params">()</span></span>&#123;</div><div class="line">		</div><div class="line">		Employee employee1 = (Employee) session.get(Employee.class, <span class="number">1</span>);</div><div class="line">		System.out.println(employee1);</div><div class="line">		</div><div class="line">		<span class="comment">//提交事务，关session</span></div><div class="line">		transaction.commit();</div><div class="line">		session.close();</div><div class="line">		</div><div class="line">		<span class="comment">//开启一个新的session和事务</span></div><div class="line">		session = sessionFactory.openSession();</div><div class="line">		transaction = session.beginTransaction();</div><div class="line">		</div><div class="line">		Employee employee2 = (Employee) session.get(Employee.class, <span class="number">1</span>);</div><div class="line">		System.out.println(employee2);</div><div class="line">	&#125;</div></pre></td></tr></table></figure></p>
<p><img src="http://static.zybuluo.com/xiangwanpeng/mpmx38y7m9ke32p7cpm15wlk/image_1b3e116cat3g1gk1fv4brlje1g.png" alt="image_1b3e116cat3g1gk1fv4brlje1g.png-34.8kB"><br>　　那么，有没有办法使就算session关闭，也能缓存employee对象的办法呢？这就是我们现在要介绍的，SessionFactory级别的，Hibernate二级缓存。<br>　　<br>　　缓存(Cache )是计算机领域非常通用的概念。它介于应用程序和永久性数据存储源(如硬盘上的文件或者数据库)之间，其作用是降低应用程序直接读写永久性数据存储源的频率，从而提高应用的运行性能。缓存中的数据是数据存储源中数据的拷贝，应用程序在运行时直接读写缓存中的数据，只在某些特定时刻按照缓存中的数据来同步更新数据存储源。缓存的物理介质通常是内存。<br>　　<br>　　Hibernate中提供了两个级别的缓存：<br>　　1.<strong>第一级别的缓存是Session级别的缓存</strong>，它是属于<strong>事务范围</strong>的缓存，即缓存只能被当前事务访问，每个事务都有独自的缓存。缓存的生命周期依赖于事务的生命周期，当事务结束时，缓存也就结束生命周期。在此范围下，缓存的介质是内存。这一级别的缓存是由hibernate管理的，一般情况下无须进行干预。<br>　　2.<strong>第二级别的缓存是SessionFactory级别的缓存</strong>，它是属于<strong>进程范围</strong>的缓存。缓存被进程内的所有事务共享。这些事务有可能是并发访问缓存，因此必须对缓存采取必要的事务隔离机制。缓存的生命周期依赖于进程的生命周期，进程结束时，缓存也就结束了生命周期。进程范围的缓存可能会存放大量的数据，所以存放的介质可以是内存或硬盘。这一级别的缓存可以进行配置和更改，并且可以动态加载和卸载。<br>　　<br>　　SessionFactory 的缓存可以分为两类：<br>　　<strong>内置缓存：</strong> Hibernate自带的，不可卸载。通常在Hibernate的初始化阶段，Hibernate会把映射元数据和预定义的SQL语句放到SessionFactory的缓存中，映射元数据是映射文件中数据的复制，而预定义SQL语句是Hibernate根据映射元数据推到出来的。该内置缓存是只读的。<br>　　<strong>外置缓存（二级缓存）：</strong>一个可配置的缓存插件。在默认情况下，SessionFactory不会启用这个缓存插件。外置缓存中的数据是数据库中数据的复制，外置缓存的物理介质可以是内存，也可以是硬盘。<br>　　<br>　　缓存的物理介质通常是内存，而永久性数据存储源的物理介质通常是硬盘或磁盘，应用程序读写内在的速度显然比读写硬盘的速度快，如果缓存中存放的数据量非常大，也会用硬盘作为缓存的物理介质。缓存的实现不仅需要作为物理介质的硬件，同时还需要用于管理缓存的并发访问和过期等策略的软件。因此，缓存是通过软件和硬件共同实现的。<br>　　<br>　　适合放入二级缓存中的数据：<br>　　1.很少被修改；<br>　　2.不是很重要的数据，允许出现偶尔的并发问题。<br>　　<br>　　不适合放入二级缓存中的数据：<br>　　1.经常被修改；<br>　　2.财务数据，绝对不允许出现并发问题；<br>　　3.与其他应用程序共享的数据。<br>　　<br>　　<strong>二级缓存的并发访问策略：</strong><br>　　两个并发的事务同时访问持久层的缓存的相同数据时，也有可能出现各类并发问题。<br>　　二级缓存可以设定以下4种类型的并发访问策略，每一种访问策略对应一种事务隔离级别。<br>　　<strong>非严格读写（Nonstrict-read-write）：</strong>不保证缓存与数据库种数据的一致性。提供read uncommitted事务隔离级别。对于极少被修改，而且允许脏读的数据，可以采用这种策略。<br>　　<strong>读写型（Read-write）</strong>：提供read committed事务隔离级别。对于经常读但是很少被修改的数据，可以采用这种隔离类型，它可以防止脏读。（通常选用的策略）<br>　　<strong>事务型（Transactional）：</strong>仅在受管理环境下适用。它提供了repeatable read的事务隔离级别。对于经常读，但是很少被修改的数据，可以采用这种隔离类型，它可以防止脏读和不可重复读。<br>　　<strong>只读型（Read-Only）：</strong>提供serializable事务隔离级别，对于从来不会修改的数据，可以采用这种访问策略，可以避免脏读，不可重复读和幻读。<br>　　<br>　　<strong>管理Hibernate的二级缓存：</strong><br>　　Hibernate的二级缓存是进程或者集群范围内的缓存。<br>　　二级缓存是可配置的插件，Hibernate允许选用以下类型的缓存插件：<br>　　EhCache：可作为进程范围的缓存，存放数据的物理介质可以是内存或硬盘，对Hibernate的查询缓存提供了支持。<br>　　OSCache：可作为进程范围的缓存，存放数据的物理介质可以是内存或硬盘，提供了丰富的缓存数据过期策略，对Hibernate的查询缓存提供了支持。<br>　　SwarmCache：可作为群集范围内的缓存，但不支持Hibernate的查询缓存。 　　JBossCache：可作为群集范围内的缓存，支持事务型并发访问策略，对Hibernate的查询缓存提供了支持。<br>　　<br><img src="http://static.zybuluo.com/xiangwanpeng/n34qwo9sqjqnvlhj6vsr7j9h/image_1b3dvptab23t1vc1v1g26c1cei9.png" alt="image_1b3dvptab23t1vc1v1g26c1cei9.png-49.7kB"></p>
<h2 id="使用Hibernate二级缓存的步骤"><a href="#使用Hibernate二级缓存的步骤" class="headerlink" title="使用Hibernate二级缓存的步骤"></a>使用Hibernate二级缓存的步骤</h2><p>　　<br><strong>一、加入二级缓存的jar包及配置文件</strong><br>　　<br>1.加入jar包<br>　　<img src="http://static.zybuluo.com/xiangwanpeng/xhbkdp4ybbp8e23umec6xqmz/image_1b3dvuhed16r4ci0ghv1aj3f4m.png" alt="image_1b3dvuhed16r4ci0ghv1aj3f4m.png-5.1kB"><br>　　<br>2.添加配置文件ehcache.xml到src目录下<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">ehcache</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="comment">&lt;!-- Sets the path to the directory where cache .data files are created.</span></div><div class="line"></div><div class="line">         If the path is a Java System Property it is replaced by</div><div class="line">         its value in the running VM.</div><div class="line"></div><div class="line">         The following properties are translated:</div><div class="line">         user.home - User's home directory</div><div class="line">         user.dir - User's current working directory</div><div class="line">         java.io.tmpdir - Default temp file path --&gt;</div><div class="line">    <span class="tag">&lt;<span class="name">diskStore</span> <span class="attr">path</span>=<span class="string">"java.io.tmpdir"</span>/&gt;</span></div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">&lt;!--Default Cache configuration. These will applied to caches programmatically created through</span></div><div class="line">        the CacheManager.</div><div class="line"></div><div class="line">        The following attributes are required for defaultCache:</div><div class="line"></div><div class="line">        maxInMemory       - Sets the maximum number of objects that will be created in memory</div><div class="line">        eternal           - Sets whether elements are eternal. If eternal,  timeouts are ignored and the element</div><div class="line">                            is never expired.</div><div class="line">        timeToIdleSeconds - Sets the time to idle for an element before it expires. Is only used</div><div class="line">                            if the element is not eternal. Idle time is now - last accessed time</div><div class="line">        timeToLiveSeconds - Sets the time to live for an element before it expires. Is only used</div><div class="line">                            if the element is not eternal. TTL is now - creation time</div><div class="line">        overflowToDisk    - Sets whether elements can overflow to disk when the in-memory cache</div><div class="line">                            has reached the maxInMemory limit.</div><div class="line"></div><div class="line">        --&gt;</div><div class="line">    <span class="tag">&lt;<span class="name">defaultCache</span></span></div><div class="line">        <span class="attr">maxElementsInMemory</span>=<span class="string">"10000"</span></div><div class="line">        <span class="attr">eternal</span>=<span class="string">"false"</span></div><div class="line">        <span class="attr">timeToIdleSeconds</span>=<span class="string">"120"</span></div><div class="line">        <span class="attr">timeToLiveSeconds</span>=<span class="string">"120"</span></div><div class="line">        <span class="attr">overflowToDisk</span>=<span class="string">"true"</span></div><div class="line">        /&gt;</div><div class="line"></div><div class="line">    <span class="comment">&lt;!--Predefined caches.  Add your cache configuration settings here.</span></div><div class="line">        If you do not have a configuration for your cache a WARNING will be issued when the</div><div class="line">        CacheManager starts</div><div class="line"></div><div class="line">        The following attributes are required for defaultCache:</div><div class="line"></div><div class="line">        name              - Sets the name of the cache. This is used to identify the cache. It must be unique.</div><div class="line">        maxInMemory       - Sets the maximum number of objects that will be created in memory</div><div class="line">        eternal           - Sets whether elements are eternal. If eternal,  timeouts are ignored and the element</div><div class="line">                            is never expired.</div><div class="line">        timeToIdleSeconds - Sets the time to idle for an element before it expires. Is only used</div><div class="line">                            if the element is not eternal. Idle time is now - last accessed time</div><div class="line">        timeToLiveSeconds - Sets the time to live for an element before it expires. Is only used</div><div class="line">                            if the element is not eternal. TTL is now - creation time</div><div class="line">        overflowToDisk    - Sets whether elements can overflow to disk when the in-memory cache</div><div class="line">                            has reached the maxInMemory limit.</div><div class="line"></div><div class="line">        --&gt;</div><div class="line"></div><div class="line">    <span class="comment">&lt;!-- Sample cache named sampleCache1</span></div><div class="line">        This cache contains a maximum in memory of 10000 elements, and will expire</div><div class="line">        an element if it is idle for more than 5 minutes and lives for more than</div><div class="line">        10 minutes.</div><div class="line"></div><div class="line">        If there are more than 10000 elements it will overflow to the</div><div class="line">        disk cache, which in this configuration will go to wherever java.io.tmp is</div><div class="line">        defined on your system. On a standard Linux system this will be /tmp"</div><div class="line">        --&gt;</div><div class="line">    <span class="tag">&lt;<span class="name">cache</span> <span class="attr">name</span>=<span class="string">"sampleCache1"</span></span></div><div class="line">        <span class="attr">maxElementsInMemory</span>=<span class="string">"10000"</span></div><div class="line">        <span class="attr">eternal</span>=<span class="string">"false"</span></div><div class="line">        <span class="attr">timeToIdleSeconds</span>=<span class="string">"300"</span></div><div class="line">        <span class="attr">timeToLiveSeconds</span>=<span class="string">"600"</span></div><div class="line">        <span class="attr">overflowToDisk</span>=<span class="string">"true"</span></div><div class="line">        /&gt;</div><div class="line"></div><div class="line">    <span class="comment">&lt;!-- Sample cache named sampleCache2</span></div><div class="line">        This cache contains 1000 elements. Elements will always be held in memory.</div><div class="line">        They are not expired. --&gt;</div><div class="line">    <span class="tag">&lt;<span class="name">cache</span> <span class="attr">name</span>=<span class="string">"sampleCache2"</span></span></div><div class="line">        <span class="attr">maxElementsInMemory</span>=<span class="string">"1000"</span></div><div class="line">        <span class="attr">eternal</span>=<span class="string">"true"</span></div><div class="line">        <span class="attr">timeToIdleSeconds</span>=<span class="string">"0"</span></div><div class="line">        <span class="attr">timeToLiveSeconds</span>=<span class="string">"0"</span></div><div class="line">        <span class="attr">overflowToDisk</span>=<span class="string">"false"</span></div><div class="line">        /&gt; --&gt;</div><div class="line"></div><div class="line">    <span class="comment">&lt;!-- Place configuration for your caches following --&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;/<span class="name">ehcache</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p><strong>二、配置hibernate.cfg.xml</strong><br>　<br>1.配置启用hibernate的二级缓存<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"cache.use_second_level_cache"</span>&gt;</span>true<span class="tag">&lt;/<span class="name">property</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>2.配置hibernate二级缓存使用的产品<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"hibernate.cache.region.factory_class"</span>&gt;</span>org.hibernate.cache.ehcache.EhCacheRegionFactory<span class="tag">&lt;/<span class="name">property</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>3.配置对哪些类（或属性）使用 hibernate 的二级缓存</p>
<p>第一种情况，类级别的二级缓存：（配置对Employee类使用二级缓存）<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">class-cache</span> <span class="attr">usage</span>=<span class="string">"read-write"</span> <span class="attr">class</span>=<span class="string">"com.atguigu.hibernate.entities.Employee"</span>/&gt;</span></div></pre></td></tr></table></figure></p>
<p>第二种情况，集合级别的二级缓存：（配置对Department类中的Employee集合属性emps使用二级缓存）<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">collection-cache</span> <span class="attr">usage</span>=<span class="string">"read-write"</span> <span class="attr">collection</span>=<span class="string">"com.atguigu.hibernate.entities.Department.emps"</span>/&gt;</span></div></pre></td></tr></table></figure></p>
<p>注意，当配置对集合属性使用二级缓存时，还需要对集合所属的类，集合中元素的类型使用二级缓存，例如，对于上述集合属性，则还需配置对Department类和Employee类使用二级缓存：（如果不对Employee类配置二级缓存，则会多出n条SQL语句，得不偿失。因为这种情况下缓存的是一个一个的employee的id，当要使用到employee对象时，需要再根据id一条一条地去数据库查询记录）<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">class-cache</span> <span class="attr">usage</span>=<span class="string">"read-write"</span> <span class="attr">class</span>=<span class="string">"com.atguigu.hibernate.entities.Department"</span>/&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">class-cache</span> <span class="attr">usage</span>=<span class="string">"read-write"</span> <span class="attr">class</span>=<span class="string">"com.atguigu.hibernate.entities.Employee"</span>/&gt;</span></div></pre></td></tr></table></figure></p>
<p>另外，配置对哪些类（或属性）使用二级缓存，还可以在映射文件中配置，例如：<br>类级别（在class节点下）：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">cache</span> <span class="attr">usage</span>=<span class="string">"read-write"</span>/&gt;</span></div></pre></td></tr></table></figure></p>
<p>集合级别：（在department映射文件的set节点下）<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;cache usage=&quot;read-write&quot;/&gt;</div></pre></td></tr></table></figure></p>
<p>　　现在，测试上面的testCache方法，只会打印一条select语句：<br>　　<img src="http://static.zybuluo.com/xiangwanpeng/48li2if3ogcht0uuoljvr125/image_1b3e2cv2vad01ntl1rt71oac7o41t.png" alt="image_1b3e2cv2vad01ntl1rt71oac7o41t.png-18kB"><br>　　对于集合的测试也是一样，只会打印两条select语句，一条用于查询department，一条用于查询employee：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Test</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testCollectionSecondLevelCache</span><span class="params">()</span></span>&#123;</div><div class="line">		Department dept = (Department) session.get(Department.class, <span class="number">1</span>);</div><div class="line">		System.out.println(dept.getName());</div><div class="line">		System.out.println(dept.getEmps().size()); </div><div class="line">		</div><div class="line">		transaction.commit();</div><div class="line">		session.close();</div><div class="line">		</div><div class="line">		session = sessionFactory.openSession();</div><div class="line">		transaction = session.beginTransaction();</div><div class="line">		</div><div class="line">		Department dept2 = (Department) session.get(Department.class, <span class="number">1</span>);</div><div class="line">		System.out.println(dept2.getName());</div><div class="line">		System.out.println(dept2.getEmps().size()); </div><div class="line">	&#125;</div></pre></td></tr></table></figure></p>
<p><img src="http://static.zybuluo.com/xiangwanpeng/2sxnp4t00twu5qsn579jf0eq/image_1b3e2epr8r731smq4t0scfca62a.png" alt="image_1b3e2epr8r731smq4t0scfca62a.png-30.6kB"></p>
<h2 id="二级缓存配置文件"><a href="#二级缓存配置文件" class="headerlink" title="二级缓存配置文件"></a>二级缓存配置文件</h2><p>　　下面使用一个修改过的二级缓存配置文件介绍其中各个属性的作用:<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">ehcache</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="comment">&lt;!-- Sets the path to the directory where cache .data files are created.</span></div><div class="line"></div><div class="line">         If the path is a Java System Property it is replaced by</div><div class="line">         its value in the running VM.</div><div class="line"></div><div class="line">         The following properties are translated:</div><div class="line">         user.home - User's home directory</div><div class="line">         user.dir - User's current working directory</div><div class="line">         java.io.tmpdir - Default temp file path --&gt;</div><div class="line">    <span class="comment">&lt;!--  </span></div><div class="line">    	指定一个目录：当 EHCache 把数据写到硬盘上时, 将把数据写到这个目录下.</div><div class="line">    --&gt;     </div><div class="line">    <span class="tag">&lt;<span class="name">diskStore</span> <span class="attr">path</span>=<span class="string">"d:\\tempDirectory"</span>/&gt;</span></div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">&lt;!--Default Cache configuration. These will applied to caches programmatically created through</span></div><div class="line">        the CacheManager.</div><div class="line"></div><div class="line">        The following attributes are required for defaultCache:</div><div class="line"></div><div class="line">        maxInMemory       - Sets the maximum number of objects that will be created in memory</div><div class="line">        eternal           - Sets whether elements are eternal. If eternal,  timeouts are ignored and the element</div><div class="line">                            is never expired.</div><div class="line">        timeToIdleSeconds - Sets the time to idle for an element before it expires. Is only used</div><div class="line">                            if the element is not eternal. Idle time is now - last accessed time</div><div class="line">        timeToLiveSeconds - Sets the time to live for an element before it expires. Is only used</div><div class="line">                            if the element is not eternal. TTL is now - creation time</div><div class="line">        overflowToDisk    - Sets whether elements can overflow to disk when the in-memory cache</div><div class="line">                            has reached the maxInMemory limit.</div><div class="line"></div><div class="line">        --&gt;</div><div class="line">    <span class="comment">&lt;!--  </span></div><div class="line">    	设置缓存的默认数据过期策略 </div><div class="line">    --&gt;    </div><div class="line">    <span class="tag">&lt;<span class="name">defaultCache</span></span></div><div class="line">        <span class="attr">maxElementsInMemory</span>=<span class="string">"10000"</span></div><div class="line">        <span class="attr">eternal</span>=<span class="string">"false"</span></div><div class="line">        <span class="attr">timeToIdleSeconds</span>=<span class="string">"120"</span></div><div class="line">        <span class="attr">timeToLiveSeconds</span>=<span class="string">"120"</span></div><div class="line">        <span class="attr">overflowToDisk</span>=<span class="string">"true"</span></div><div class="line">        /&gt;</div><div class="line"></div><div class="line">   	<span class="comment">&lt;!--  </span></div><div class="line">   		设定具体的命名缓存的数据过期策略。每个命名缓存代表一个缓存区域</div><div class="line">   		缓存区域(region)：一个具有名称的缓存块，可以给每一个缓存块设置不同的缓存策略。</div><div class="line">   		如果没有设置任何的缓存区域，则所有被缓存的对象，都将使用默认的缓存策略。即：&lt;defaultCache.../&gt;</div><div class="line">   		Hibernate 在不同的缓存区域保存不同的类/集合。</div><div class="line">			对于类而言，区域的名称是类名。如:com.atguigu.domain.Customer</div><div class="line">			对于集合而言，区域的名称是类名加属性名。如com.atguigu.domain.Customer.orders</div><div class="line">   	--&gt;</div><div class="line">   	<span class="comment">&lt;!--  </span></div><div class="line">   		name: 设置缓存的名字,它的取值为类的全限定名或类的集合的名字 </div><div class="line">		maxElementsInMemory: 设置基于内存的缓存中可存放的对象最大数目 </div><div class="line">		</div><div class="line">		eternal: 设置对象是否为永久的, true表示永不过期,</div><div class="line">		此时将忽略timeToIdleSeconds 和 timeToLiveSeconds属性; 默认值是false </div><div class="line">		timeToIdleSeconds:设置对象空闲最长时间,以秒为单位, 超过这个时间,对象过期。</div><div class="line">		当对象过期时,EHCache会把它从缓存中清除。如果此值为0,表示对象可以无限期地处于空闲状态。 </div><div class="line">		timeToLiveSeconds:设置对象生存最长时间,超过这个时间,对象过期。</div><div class="line">		如果此值为0,表示对象可以无限期地存在于缓存中. 该属性值必须大于或等于 timeToIdleSeconds 属性值 </div><div class="line">		</div><div class="line">		overflowToDisk:设置基于内存的缓存中的对象数目达到上限后,是否把溢出的对象写到基于硬盘的缓存中 </div><div class="line">   	--&gt;</div><div class="line">    <span class="tag">&lt;<span class="name">cache</span> <span class="attr">name</span>=<span class="string">"com.atguigu.hibernate.entities.Employee"</span></span></div><div class="line">        <span class="attr">maxElementsInMemory</span>=<span class="string">"1"</span></div><div class="line">        <span class="attr">eternal</span>=<span class="string">"false"</span></div><div class="line">        <span class="attr">timeToIdleSeconds</span>=<span class="string">"300"</span></div><div class="line">        <span class="attr">timeToLiveSeconds</span>=<span class="string">"600"</span></div><div class="line">        <span class="attr">overflowToDisk</span>=<span class="string">"true"</span></div><div class="line">        /&gt;</div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">cache</span> <span class="attr">name</span>=<span class="string">"com.atguigu.hibernate.entities.Department.emps"</span></span></div><div class="line">        <span class="attr">maxElementsInMemory</span>=<span class="string">"1000"</span></div><div class="line">        <span class="attr">eternal</span>=<span class="string">"true"</span></div><div class="line">        <span class="attr">timeToIdleSeconds</span>=<span class="string">"0"</span></div><div class="line">        <span class="attr">timeToLiveSeconds</span>=<span class="string">"0"</span></div><div class="line">        <span class="attr">overflowToDisk</span>=<span class="string">"false"</span></div><div class="line">        /&gt;</div><div class="line"></div><div class="line"><span class="tag">&lt;/<span class="name">ehcache</span>&gt;</span></div></pre></td></tr></table></figure></p>
<h2 id="查询缓存"><a href="#查询缓存" class="headerlink" title="查询缓存"></a>查询缓存</h2><p>　　对于经常使用的查询语句，如果启用了查询缓存，当第一次执行查询语句时，Hibernate会把查询结果存放在查询缓存中，以后再次执行该查询语句时，只需从缓存中获得查询结果，从而提高查询性能。<br>　　默认情况下，Hibernate设置的缓存对HQL和QBC查询是无效的，但可以通过以下步骤使其有效：<br>　　1.配置二级缓存，因为查询缓存依赖于二级缓存.<br>　　2.在hibernate配置文件中声明开启查询缓存。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"cache.use_query_cache"</span>&gt;</span>true<span class="tag">&lt;/<span class="name">property</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>　　3.调用Query或者Criteria的setCachable(true)。<br>　　<br>例如，在没有配置查询缓存的情况下，下面的代码会打印两条select语句:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Test</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testQueryCache</span><span class="params">()</span></span>&#123;</div><div class="line">		Query query = session.createQuery(<span class="string">"FROM Employee"</span>);</div><div class="line">		</div><div class="line">		List&lt;Employee&gt; emps = query.list();</div><div class="line">		System.out.println(emps.size());</div><div class="line">		</div><div class="line">		emps = query.list();</div><div class="line">		System.out.println(emps.size());</div><div class="line">		</div><div class="line">	&#125;</div></pre></td></tr></table></figure></p>
<p><img src="http://static.zybuluo.com/xiangwanpeng/v01g0t17ve9vk8b8uulewebm/image_1b3e39bve1vg91r2t12i65c91n782n.png" alt="image_1b3e39bve1vg91r2t12i65c91n782n.png-30.6kB"><br>　　<br>　　进行了相关配置之后，并且在方法中设置query.setCacheable(true);则只会打印一条select语句：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Test</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testQueryCache</span><span class="params">()</span></span>&#123;</div><div class="line">		Query query = session.createQuery(<span class="string">"FROM Employee"</span>);</div><div class="line">		query.setCacheable(<span class="keyword">true</span>);</div><div class="line">		</div><div class="line">		List&lt;Employee&gt; emps = query.list();</div><div class="line">		System.out.println(emps.size());</div><div class="line">		</div><div class="line">		emps = query.list();</div><div class="line">		System.out.println(emps.size());</div><div class="line">		</div><div class="line">	&#125;</div></pre></td></tr></table></figure></p>
<p><img src="http://static.zybuluo.com/xiangwanpeng/9c941z5p6fxhofiee5cj0hvq/image_1b3e3bndj184be4f1mga1gi81baq34.png" alt="image_1b3e3bndj184be4f1mga1gi81baq34.png-18.5kB"></p>
<p>　　查询缓存适用于如下场合：<br>　　1.应用程序运行时经常使用查询语句<br>　　2.很少对与查询语句检索到的数据进行插入，删除或更新操作</p>
<h2 id="时间戳缓存区域"><a href="#时间戳缓存区域" class="headerlink" title="时间戳缓存区域"></a>时间戳缓存区域</h2><p>　　时间戳缓存区域存放了对于查询结果相关的表进行插入，更新或者删除操作的时间戳。Hibernate通过时间戳缓存区域来判断被缓存的查询结果是否过期，其运行过程如下：<br>　　T1时刻执行查询操作，把结果存放在QueryCache区域，记录该区域的时间戳为T1；<br>　　T2时刻（可能在T1之前，也可能在T1之后）对查询结果相关的表进行更新操作，Hibernate把T2时刻存放在UpdateTimestampCache区域。<br>　　T3时刻（在T1，T2之后）执行查询结果前，先比较QueryCache区域的时间戳和UpdateTimestampCache区域的时间戳。若T2&gt;T1，则丢弃原先存放在QueryCache区域的查询结果，重新到数据库中查询数据并放入QueryCache区域；若T2<t1，则直接从querycache中获得查询结果。 　　下面的代码演示了时间戳缓存的作用：="" <figure="" class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Test</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testUpdateTimeStampCache</span><span class="params">()</span></span>&#123;</div><div class="line">		Query query = session.createQuery(<span class="string">"FROM Employee"</span>);</div><div class="line">		query.setCacheable(<span class="keyword">true</span>);</div><div class="line">		</div><div class="line">		List&lt;Employee&gt; emps = query.list();</div><div class="line">		System.out.println(emps.size());</div><div class="line">		</div><div class="line">		Employee employee = (Employee) session.get(Employee.class, <span class="number">1</span>);</div><div class="line">		employee.setSalary(<span class="number">30000</span>);</div><div class="line">		</div><div class="line">		emps = query.list();</div><div class="line">		System.out.println(emps.size());</div><div class="line">	&#125;</div></pre></td></tr></table></t1，则直接从querycache中获得查询结果。></p>
<p>　　在第二次查询的时候，会重新用select去数据库中查找最新的记录。<br>　　<img src="http://static.zybuluo.com/xiangwanpeng/y4x79wavot7kuxm28v8vr8be/image_1b3e56hbmjqu3n719ono39k8m3h.png" alt="image_1b3e56hbmjqu3n719ono39k8m3h.png-40.9kB"></p>
<h2 id="Query接口的iterate-方法"><a href="#Query接口的iterate-方法" class="headerlink" title="Query接口的iterate()方法"></a>Query接口的iterate()方法</h2><p>　　Query的list方法返回实体类对应表的所有字段，而Query的iterate方法仅返回数据包的ID字段。当使用了iterate方法，然后遍历访问结果集时，先到Session缓存及二级缓存中查看是否存在特定OID的对象，如果存在，直接返回，否则就通过相应的SQL SELECT语句到数据库中查找特定的记录。<br>　　在大多数情况下，应该考虑使用list方法执行查询操作，iterate方法仅在下述情况下可以稍微提高查询性能：<br>　　1.要查询的数据表中包含大量字段；<br>　　2.启用了二级缓存，且二级缓存中可能已经包含了待查询的对象。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/7/">7</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel  sidebar-panel-active ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/image/avatar.png"
               alt="Alan" />
          <p class="site-author-name" itemprop="name">Alan</p>
          <p class="site-description motion-element" itemprop="description">Better late than never.</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">61</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">11</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">74</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/xiangwanpeng" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://weibo.com/u/2810288024/home" target="_blank" title="weibo">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  weibo
                </a>
              </span>
            
          
        </div>

        
        

        
        

      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2016</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Alan</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/VEN/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/VEN/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/VEN/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/VEN/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/VEN/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/VEN/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.1"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.0.1"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.1"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"xiangwanpeng"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
    <script src="/VEN/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>
    <script src="/js/src/hook-duoshuo.js"></script>
  






  
  

  

  

  

</body>
</html>
